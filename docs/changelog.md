## [2024-12-19] - Автоматическая синхронизация при переключении настроек Allegro

### Добавлено
- Автоматический запуск синхронизации остатков при включении настройки `stock_sync_enabled`
- Автоматический запуск синхронизации цен при включении настройки `price_sync_enabled`
- Автоматический запуск синхронизации цен при обновлении мультипликатора цены
- Новая Celery задача `sync_allegro_stock_single_product_account` для синхронизации остатков конкретного товара с конкретным аккаунтом
- Новая Celery задача `sync_allegro_price_single_product_account` для синхронизации цен конкретного товара с конкретным аккаунтом

### Изменено
- Endpoint `/{sku}/sync-settings/{account_name}/toggle-stock` теперь автоматически запускает синхронизацию остатков при включении
- Endpoint `/{sku}/sync-settings/{account_name}/toggle-price` теперь автоматически запускает синхронизацию цен при включении
- Endpoint `/{sku}/sync-settings/{account_name}/update-multiplier` теперь автоматически запускает синхронизацию цен при обновлении мультипликатора

### Техническая информация
- Задачи синхронизации запускаются асинхронно и не блокируют HTTP-ответ
- При ошибке запуска задачи ошибка логируется, но не прерывает выполнение основного запроса
- Задачи проверяют актуальность настроек синхронизации перед выполнением
- Используется существующая инфраструктура `sync_allegro_offers_batch` для реальной синхронизации

## [2024-12-19] - Исправление функции перемещения товаров

### Исправлено
- Исправлена ошибка 422 при перемещении товаров на странице управления товаром
- Заменен неправильный endpoint `/api/warehouse/transfer/` на правильный `/api/warehouse/transfer-item/`
- Удалено поле `comment` из запроса перемещения, так как API его не поддерживает
- Убрано поле для комментария из формы перемещения товаров
- Теперь перемещение товаров работает корректно с правильной моделью данных

### Техническая информация
- Endpoint `/api/warehouse/transfer/` предназначен для загрузки файлов с перемещениями
- Endpoint `/api/warehouse/transfer-item/` предназначен для отдельных перемещений товаров
- Модель `TransferItem` содержит поля: `sku`, `from_warehouse`, `to_warehouse`, `quantity`

## [2024-12-19] - Обновление системы синхронизации остатков с Allegro

### Изменено
- Обновлена архитектура задач синхронизации остатков для учета индивидуальных настроек товаров
- Функция `sync_allegro_stock_single_product` теперь проверяет флаг `stock_sync_enabled` для каждого аккаунта
- Функция `sync_allegro_stock_single_account` получает только товары с включенной синхронизацией для конкретного аккаунта
- Функция `sync_allegro_stock_all_accounts` делегирует логику выбора товаров в `sync_allegro_stock_single_account`
- Функция `sync_allegro_offers_batch` фильтрует SKU по настройкам синхронизации перед обработкой
- Добавлены синхронные версии методов в `ProductAllegroSyncService`: `should_sync_product_sync` и `get_products_for_stock_sync_sync`

### Добавлено
- Интеграция с моделью `ProductAllegroSyncSettings` в задачи синхронизации
- Проверка настроек синхронизации для каждой пары товар-аккаунт перед запуском синхронизации
- Детальное логирование для отслеживания, какие товары синхронизируются с какими аккаунтами
- Обратная совместимость: при отсутствии настроек проверяется флаг `is_sync_enabled` в модели `Product`

### Исправлено
- Устранена проблема запуска синхронизации для всех аккаунтов без учета индивидуальных настроек
- Оптимизирован процесс синхронизации: теперь обрабатываются только товары с включенной синхронизацией
- Улучшена производительность за счет фильтрации товаров на уровне задач

## [2024-01-17] - Переход к минимальной структуре данных для цен

### Изменено
- Полностью переведена система на минимальную структуру данных для цен
- В базе данных: только sku (PRIMARY KEY) и min_price (NUMERIC)
- Удалены поля price, currency, updated_at из всех эндпоинтов и шаблонов
- Заменены price_info.price на price_info.min_price во всех маршрутах
- Упрощена PriceDataResponse: убраны @property методы для совместимости
- Обновлены шаблоны product_card.html и product_manage.html для работы с min_price
- Исправлены JavaScript функции для работы с минимальной структурой
- Валюта теперь фиксированная PLN во всех отображениях

### Исправлено
- Устранены ошибки в логах: "'PriceDataResponse' object has no attribute 'updated_at'"
- Исправлена несогласованность между структурой БД и кодом приложения
- Исправлена логика отображения цены: теперь цена 0 отображается корректно, а "Не указана" показывается только при отсутствии записи в БД
- Изменены условия с `{% if product.min_price %}` на `{% if product.min_price is not none %}` в шаблонах
- Исправлена проблема с редактированием цены в каталоге: перенесены модальное окно и JavaScript функции из product_card.html в catalog.html для избежания конфликтов ID

## [2024-12-20] - Интеграция с удаленной БД цен товаров

### Добавлено
- Создан сервис для работы с удаленной БД цен (`app/services/prices_service.py`)
- Добавлены модели для работы с таблицей `prices_data` (PriceData, PriceDataCreate, PriceDataUpdate, PriceDataResponse)
- Создан класс PricesService с полным интерфейсом для работы с ценами
- Добавлены API роуты для управления ценами (`/api/prices/`)
- Интеграция отображения цен в карточках товаров каталога
- Добавлено редактирование цен администраторами прямо в карточке товара
- Отображение цен на странице управления товаром с возможностью редактирования
- Поддержка валют (PLN по умолчанию) для цен товаров
- Массовые операции с ценами (batch update, import)
- Статистика по ценам (количество, средняя/мин/макс цена)
- Адаптация под реальную структуру таблицы: `sku` (PRIMARY KEY), `min_price` (NUMERIC)

### Улучшено
- Карточки товаров теперь показывают актуальные цены из удаленной БД
- Добавлены модальные окна для редактирования цен администраторами
- Автоматическое обогащение данных о товарах ценами при загрузке каталога
- Graceful fallback при недоступности БД цен

### Техническое описание
- Добавлена конфигурация для подключения к удаленной БД цен (PRICES_DB_URI, PRICES_DB_URI_ASYNC)
- Реализован полный CRUD для работы с ценами через REST API
- Добавлена обработка ошибок и fallback для случаев недоступности БД цен
- Интеграция с существующей архитектурой проекта без breaking changes
- Поддержка как синхронных, так и асинхронных операций с БД цен

## [2024-12-20] - Исправлена функциональность страницы управления товаром

### Исправлено
- Исправлена ошибка SQLAlchemy ArgumentError в модели ProductAllegroSyncSettings
- Устранена проблема с неправильным определением relationship в модели
- Исправлена маршрутизация для страницы управления товаром (/products/{sku}/manage)
- Разделены роутеры: каталог доступен по /catalog, управление товарами по /products/{sku}/manage
- Исправлена логика отображения остатков - теперь показываются все склады, даже с нулевыми остатками
- Исправлены API эндпоинты для тоглов синхронизации (убран лишний /v1 из URL)
- Добавлена кнопка "Применить" для мультипликатора цены вместо автоматического обновления

### Улучшено
- Теперь отображаются все склады из enum Warehouses, даже если для товара нет записей в таблице stock
- Улучшена UX - мультипликатор цены применяется по кнопке, а не автоматически при изменении

### Техническое описание
- Убран неправильный параметр foreign_keys из определения relationship в ProductAllegroSyncSettings
- Создан отдельный catalog_router для каталога без префикса
- Исправлена логика формирования stock_by_warehouse для показа всех складов
- Исправлены URL в JavaScript: заменен /api/v1/ на /api/
- Заменен onchange на кнопку "Применить" для мультипликатора

## [2024-12-20] - Исправлен круговой импорт в модулях Celery

### Исправлено
- Решена проблема кругового импорта между app/celery_app.py, app/services/warehouse/manager.py и app/services/allegro/sync_tasks.py
- Создан отдельный модуль app/celery_shared.py для общих объектов Celery
- Перенесены celery, SessionLocal, get_allegro_token в общий модуль
- Обновлены импорты в зависимых модулях

### Улучшено
- Улучшена архитектура модулей - устранена циклическая зависимость
- Разделены обязанности: celery_shared.py содержит только общие объекты, celery_app.py - только задачи
- Повышена стабильность запуска приложения

### Техническое описание
- Создан app/celery_shared.py с инициализацией celery и общими функциями
- Обновлен app/celery_app.py - убраны общие объекты, оставлены только задачи
- Обновлен app/services/allegro/sync_tasks.py - изменен импорт с celery_app на celery_shared
- Исправлена ImportError: cannot import name 'celery' from partially initialized module

## [2024-12-20] - Исправлена работа совместного использования фильтров по остаткам

### Исправлено
- Исправлена проблема с одновременным использованием фильтров по минимальному и максимальному количеству
- Объединение условий фильтрации в один вызов .having() с логическим AND
- Исправлена логика JavaScript для передачи параметров фильтров на сервер
- Добавлена автоматическая коррекция некорректных значений фильтров (когда max < min)
- Теперь фильтры "Остаток меньше чем" и "Остаток больше чем" работают корректно вместе

### Улучшено
- Улучшен пользовательский интерфейс фильтров: заменены символы "< 999" и "> 999" на понятные "Макс." и "Мин."
- Добавлены математические символы ≤ и ≥ над полями фильтров для лучшего понимания
- Добавлены подсказки (title) для полей фильтров
- Увеличена ширина полей фильтров для лучшего восприятия

### Техническое описание
- Заменены отдельные вызовы .having() на единый вызов с объединенными условиями
- Добавлена логика сбора условий фильтрации в массив having_conditions
- Использование sqlalchemy.and_() для корректного объединения условий
- Исправлен JavaScript код в handleFilterChange() и goToPage() для правильной передачи параметров
- Параметры stock_filter и min_stock_filter теперь отправляются только когда поля заполнены
- Убрана проверка >= 0 в бэкенде, поскольку пустые поля больше не отправляются как -1
- Добавлена валидация параметров фильтров с автоматической коррекцией некорректных значений

## [2024-12-20] - Исправлена ошибка 405 Method Not Allowed в API Allegro и добавлена таблица блокировок
### Исправлено
- Ошибка 405 Method Not Allowed при обновлении остатков офферов Allegro
- Создан новый метод update_offer_stock() использующий правильный API endpoint
- Заменен PATCH запрос на PUT /sale/offer-quantity-change-commands/{commandId}
- Добавлена миграция для создания таблицы productsynclock
- Исправлена ошибка "relation productsynclock does not exist"

### Предыдущие исправления
- TypeError: InventoryManager.__init__() missing 2 required positional arguments: 'dsn' and 'async_dsn'
- Заменен прямой вызов InventoryManager() на get_manager() в sync_tasks.py
- Обновлены импорты для корректной работы с менеджером инвентаря
- Исправлен вызов несуществующего метода get_total_stock() на get_stock_by_sku() с суммированием остатков

### Предыдущие изменения
- Ошибка AttributeError: 'str' object has no attribute 'get' в sync_allegro_offers_batch
- Корректная обработка ответа API get_offers (извлечение списка офферов из ответа)
- Улучшено логирование процесса синхронизации с детальной информацией о типах данных
- Детальное логирование в sync_allegro_offers_batch для отладки
- Проверка типов данных в процессе синхронизации
- Защита от некорректных данных с информативными сообщениями об ошибках
- Логирование каждого этапа обработки офферов

## [2024-12-20] - Добавлены расширенные фильтры каталога товаров
### Добавлено
- Фильтр "Остаток больше чем" для минимального количества товаров
- Отдельный фильтр по бренду через выпадающий список
- API endpoint GET /api/products/brands для получения списка уникальных брендов
- Поддержка параметра brand_filter в эндпоинтах каталога
- Поддержка параметра min_stock_filter в эндпоинтах каталога
- Динамическая загрузка списка брендов при инициализации страницы

### Изменено
- Десктопная версия каталога использует кастомную сетку фильтров с оптимизированными размерами
- Поле поиска максимально расширено для удобства ввода (поиск только по названию, SKU, EAN)
- Поля фильтрации остатков компактные (80px) с символами < и > в плейсхолдерах
- Ограничение ввода до 3 символов для полей остатков с центрированием текста
- Мобильная версия включает новые поля фильтрации с аналогичными изменениями
- JavaScript функции обновлены для поддержки новых фильтров
- Функция getActiveFormElements включает новые поля фильтрации

### Удалено
- Поиск по бренду из строки поиска (теперь только через отдельный фильтр)

## [2024-12-20] - Добавлено поле редактирования бренда товара и поиск по бренду
### Добавлено
- Поле "Бренд" в форму редактирования товара (edit_product.html)
- Обработка параметра brand в API endpoint PUT /api/products/{sku}
- Валидация поля бренда: пустая строка преобразуется в NULL
- Логирование изменений бренда в операциях редактирования товара
- Поиск по полю бренда в каталоге товаров (Product.brand.ilike)

### Изменено
- Форма редактирования товара теперь включает поле для изменения бренда
- API endpoint обновления товара поддерживает изменение бренда
- Данные для формы редактирования включают текущее значение бренда
- Поисковая строка теперь ищет по названию, SKU, EAN и бренду
- Обновлены placeholder'ы в поисковых полях каталога

## [2024-12-20] - Добавлена синхронизация одного товара по всем аккаунтам Allegro
### Добавлено
- Celery задача sync_allegro_stock_single_product для синхронизации одного товара по всем аккаунтам
- API endpoint POST /api/products/{sku}/sync-allegro для запуска синхронизации товара
- Кнопка "Синхронизировать" в карточке товара для ручного запуска синхронизации
- JavaScript функция syncProductAllegro для обработки клика на кнопку синхронизации
- Проверка существования товара в БД перед синхронизацией
- Проверка флага is_sync_enabled для товара перед синхронизацией
- Обновлено описание файла sync_tasks.py для отражения новой функциональности

### Изменено
- Обновлены dependencies в описании модуля sync_tasks.py
- Улучшена структура блока синхронизации в карточке товара
- Кнопка синхронизации отображается только при включенном флаге is_sync_enabled

## [2024-12-20] - Реализация UI управления синхронизацией товаров
### Добавлено
- Подпись "Allegro:" перед toggle переключателем синхронизации
- Подробный tooltip с описанием функции синхронизации
- API endpoint PATCH /api/products/{sku}/sync-flag для переключения флага синхронизации
- Новый тип операции PRODUCT_SYNC_TOGGLE для логирования изменений флага
- Метод create_product_sync_toggle_operation в OperationsService
- JavaScript функция toggleSyncFlag с обновлением UI в реальном времени

### Изменено
- Улучшен UI карточки товара: добавлена подпись и детальный tooltip
- Обновлена структура toggle элементов для лучшей читаемости

## [2024-06-13] - Этапы реализации автоматической синхронизации остатков с Allegro
### Завершено
- Реализован пайплайн Celery задач для массовой синхронизации остатков
- Добавлен rate limiter для соблюдения лимитов API Allegro
- Реализована система уведомлений об ошибках в Telegram
- Добавлено детальное логирование и мониторинг
- Добавлен булевый флаг is_sync_enabled в модель товара и миграция

### В процессе
- Обновление бизнес-логики синхронизации: сначала is_sync_enabled, затем логи с локами
- Реализация и интеграция механизма блокировок (локов) для защиты от дублирующихся обновлений по SKU

### Запланировано
- Кнопка в UI карточки товара для ручного включения/отключения синхронизации
- Интеграция задачи в планировщик Celery Beat 

## [2024-12-19] - Переработка системы синхронизации товаров с Allegro
### Добавлено
- Новая модель `ProductAllegroSyncSettings` для индивидуальных настроек синхронизации по аккаунтам
- Страница управления товаром `/products/{sku}/manage` с детальными настройками синхронизации
- API эндпоинты для управления настройками синхронизации:
  - `POST /api/v1/products/{sku}/sync-settings` - создание/обновление настроек
  - `GET /api/v1/products/{sku}/sync-settings` - получение всех настроек
  - `POST /api/v1/products/{sku}/sync-settings/{account_name}/toggle-stock` - переключение синхронизации остатков
  - `POST /api/v1/products/{sku}/sync-settings/{account_name}/toggle-price` - переключение синхронизации цен
  - `POST /api/v1/products/{sku}/sync-settings/{account_name}/update-multiplier` - обновление мультипликатора цены
- Возможность настройки мультипликатора цены для каждого аккаунта Allegro отдельно
- Отдельные настройки синхронизации остатков и цен для каждого аккаунта
- Красивый интерфейс управления настройками синхронизации с переключателями и полями ввода

### Изменено
- Заменен тогл синхронизации на кнопку "Управление" в карточке товара
- Админы получают кнопку "Управление", обычные пользователи - кнопку "Просмотр"
- Настройки синхронизации теперь глобальные для всех пользователей системы
- Упрощена архитектура - убрана привязка к пользователю в настройках

### Удалено
- Старый JavaScript код для тогла синхронизации в product_card.html
- Зависимость от прямой привязки к токену в модели настроек

### Техническая информация
- Модель `ProductAllegroSyncSettings` использует составной ключ `product_sku + allegro_account_name`
- Подготовлена архитектура для будущего перехода на микросервисную систему
- Сохранена обратная совместимость с существующим полем `is_sync_enabled` в модели Product 