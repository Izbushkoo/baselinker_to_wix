## [2024-12-28] - Исправление формирования URL для operation_id и полная локализация логов
### Исправлено
- Исправлена корявая ссылка в Telegram уведомлениях - теперь правильно формируется URL для operation_id
- Исправлена функция `_get_operation_url` в сервисе уведомлений для корректного формирования параметров URL
- Убрана неправильная формация operation_key в уведомлениях о провале валидации

### Изменено  
- Все сообщения в `self._log_operation` переведены на русский язык (26 сообщений в файле stock_synchronization_service.py)
- URL для операций теперь формируются как `stock-sync/monitor?operation_id={operation_id}` вместо неправильного пути
- Уведомления о провале валидации теперь ссылаются на мониторинг с фильтрами по order_id и account

## [2024-12-28] - Локализация и улучшение UX мониторинга складских операций
### Добавлено
- Локализация логов операций синхронизации складов - все действия и сообщения теперь на русском языке
- Функция копирования SKU в интерфейсе деталей операций с уведомлением об успешном копировании
- Улучшенное форматирование Telegram уведомлений для ошибок валидации с группировкой по типам
- Отображение названий товаров, количества и кнопок копирования SKU в Telegram уведомлениях
- Система фильтров для локализации сообщений в Jinja2 шаблонах
- Красивое форматирование подробных данных логов с декодированием Unicode и структурированным отображением

### Улучшено  
- Детали ошибок валидации теперь показывают больше контекстной информации
- Telegram уведомления стали более структурированными и читаемыми
- Добавлена обработка длинных названий товаров в уведомлениях
- Улучшен UX копирования SKU с визуальной обратной связью
- Подробные данные логов теперь отображаются в читаемом формате вместо сырого JSON
- Добавлено декодирование Unicode символов в деталях логов
- SKU в подробных данных стали копируемыми

### Изменено
- Сообщения логов операций переведены на русский язык с сохранением технической точности
- Формат Telegram уведомлений изменен для лучшей читаемости и действенности

## [2024-12-28] - Исправление шаблонов и авторизации мониторинга
### Исправлено
- Шаблон `operation_details.html` теперь правильно наследуется от `base.html` и использует Tailwind CSS
- Исправлена проблема с авторизацией в роутах `/stock-sync/monitor` - теперь правильно передаются данные пользователя в шаблоны
- Устранена ошибка "UUID object is not subscriptable" в шаблонах при обработке идентификаторов операций
- Улучшен дизайн страницы деталей операций с использованием современных компонентов Tailwind CSS

### Изменено
- Шаблон `operation_details.html` полностью переписан с использованием Tailwind CSS классов
- Добавлена передача объектов `user` и `current_user` в контекст шаблонов мониторинга
- Улучшена обработка UUID объектов в Jinja2 шаблонах

## [2024-12-28] - Исправление ошибок и улучшение уведомлений
### Исправлено
- Устранена ошибка `'str' is undefined` в методе `is_ready_for_retry` модели `PendingStockOperation`
- Убрано использование несуществующего атрибута `MONITOR_URL` из конфигурации `StockSyncConfig`
- Добавлена обработка ошибок при форматировании логов в функциях `get_operation_details` и `operation_details_page`
- Улучшена стабильность загрузки деталей операций при наличии поврежденных логов

### Добавлено
- Поле `BASE_URL` в основную конфигурацию приложения для генерации ссылок в уведомлениях
- Методы `_get_operation_url` и `_get_monitoring_url` для генерации ссылок на детали операций
- Ссылки в Telegram уведомления на детали операций и страницу мониторинга (при наличии `BASE_URL`)
- Пример настройки `BASE_URL` в `example.env`

### Изменено
- Метод `is_ready_for_retry` теперь принимает `max_retries` как параметр вместо поля модели
- Улучшена проверка на `next_retry_at` в методе `is_ready_for_retry` (добавлена проверка на `None`)
- Сервис уведомлений теперь использует централизованную конфигурацию для базового URL

## [2024-12-28] - Упрощение интерфейса мониторинга синхронизации складов
### Добавлено
- Система фильтрации операций по ID заказа, имени аккаунта и статусу
- Поле `account_name` в модель `PendingStockOperation` для хранения имени аккаунта Allegro
- Новый API endpoint `/api/stock-sync/operations` для получения всех операций с фильтрацией
- Поиск по Enter в полях фильтров для удобства использования
- Локализация статусов операций на русский язык

### Изменено
- Упрощена таблица операций: убраны лишние колонки (ID операции, склад, время создания, позиции)
- Изменена логика попыток: убрано поле `max_retries`, оставлен только `retry_count` (количество выполненных попыток)
- Обновлен метод `increment_retry` в модели для работы без максимального лимита попыток
- Улучшен UI: добавлены фильтры в отдельном блоке с современным дизайном
- Оптимизирована структура данных API ответа

### Исправлено
- Убраны несуществующие поля `sku` и `quantity` из API ответа
- Исправлена работа с полем `line_items` для корректного отображения позиций заказа
- Обновлена логика отображения имени аккаунта (теперь используется поле `account_name`)

## [2024-12-28] - Исправление критических ошибок в API endpoints
### Исправлено
- **КРИТИЧЕСКОЕ**: Ошибка 401 Unauthorized при загрузке данных мониторинга синхронизации складов
- **КРИТИЧЕСКОЕ**: Ошибка "'generator' object has no attribute 'exec'" в API endpoints
- **КРИТИЧЕСКОЕ**: Ошибка "'PendingStockOperation' object has no attribute 'sku'" в API endpoints
- Неправильные пути к API endpoints (исправлено с `/api/stock-sync/` на `/api/v1/stock-sync/`)
- Несовместимость аутентификации: API ожидал Bearer token, веб-интерфейс использовал cookie
- Неправильное использование `get_session()` вместо `get_db()` в зависимостях
- Попытка доступа к несуществующим полям `sku` и `quantity` в модели PendingStockOperation
- Изменены зависимости аутентификации с `get_current_user` на `get_current_user_optional` для совместимости
- Добавлена правильная отправка cookie в JavaScript fetch запросах
- Добавлено автоматическое перенаправление на страницу входа при ошибке аутентификации

### Изменено
- Обновлен JavaScript код в `stock_monitoring.html` для корректной работы с API
- Добавлены заголовки `Accept` и `Content-Type` для API запросов
- Улучшена обработка ошибок аутентификации с пользовательским опытом
- Исправлены все зависимости базы данных в stock_sync роутере
- Добавлена колонка "Позиции" в таблицу мониторинга для отображения информации о line_items
- Обновлена логика отображения данных операций с учетом реальной структуры модели

## [2024-12-28] - Рефакторинг шаблона мониторинга синхронизации складов
### Добавлено
- Интеграция с базовым шаблоном сайта для единообразного дизайна
- Использование Tailwind CSS вместо встроенных стилей для лучшей производительности
- Адаптивный дизайн с использованием Tailwind grid и responsive классов
- Современные hover-эффекты и анимации для карточек статистики

### Изменено
- Полностью переработан HTML-код для использования Jinja2 наследования (`{% extends "base.html" %}`)
- Заменены встроенные CSS стили на Tailwind CSS классы
- Обновлен JavaScript код для работы с Tailwind классами (hidden вместо style.display)
- Улучшена структура таблицы с sticky заголовками и лучшим разделением строк

### Исправлено
- Убраны дублирующиеся HTML теги (html, head, body) для корректного наследования
- Исправлена работа с DOM элементами для совместимости с Tailwind CSS
- Улучшена доступность с помощью семантических Tailwind классов

## [2024-12-28] - Улучшен интерфейс мультипликатора цены
### Добавлено
- Динамическое обновление текста мультипликатора при изменении значения в реальном времени
- Возможность ввода значений меньше 1.0 для создания скидок (минимум 0.1)
- Автоматический расчет и отображение процента наценки/скидки при вводе
- JavaScript функция `updateMultiplierText()` для мгновенного обновления интерфейса

### Изменено
- Изменено минимальное значение мультипликатора с 0.01 на 0.1 для лучшего UX
- Добавлен обработчик `oninput` для мгновенного обновления текста при вводе

### Исправлено
- **КРИТИЧЕСКОЕ**: Исправлена глобальная валидация полей number, которая мешала вводу значений < 1
- Исключены поля мультипликатора и цены из принудительной валидации минимального значения
- Теперь можно свободно вводить значения меньше 1.0 в поле мультипликатора

## [2024-12-28] - Исправлена система подсчета остатков и автообновления
### Исправлено
- **КРИТИЧЕСКОЕ**: Ошибка двойного подсчета общих остатков на складах (показывало удвоенное количество)
- Корректная синхронизация атрибутов data-current-quantity между кнопками и input при изменении остатков
- Функция updateTotalStock() теперь использует только кнопки "Списать" для избежания дублирования
- Обновление всех связанных элементов (input, кнопки списания и пополнения) при изменении остатков

## [2024-12-28] - Добавлено расширенное автообновление оферт
### Добавлено
- Автообновление оферт после обновления мультипликатора цены (с задержкой 3 сек)
- Автообновление оферт после синхронизации цены для аккаунта (с задержкой 3 сек)
- Увеличена задержка автообновления до 3 секунд для корректного отображения изменений

### Исправлено
- Ошибка обработки NULL значений в данных цены от API Allegro
- Корректная обработка случаев когда currentPrice или price равны null

## [2024-12-28] - Обновлен интерфейс блока оферт Allegro
### Добавлено
- Новый дизайн интерфейса оферт: заголовок "Оферта [ID]" + текущая цена справа
- Автоматическое обновление оферт при изменениях цен, остатков и настроек синхронизации
- Кнопка обновления оферт (иконка refresh) для ручного обновления
- Клик по контейнеру оферты разворачивает детальную информацию
- Отображение основных данных: название, остатки (доступно/продано), статус публикации
- Детальная информация об оферте при развороте: статистика, условия продажи, публикация

### Изменено
- Убрана кнопка "Показать/Скрыть оферты", вместо этого оферты отображаются сразу
- Обновлена структура данных API endpoint для корректного извлечения цены из saleInfo.currentPrice
- Упрощен интерфейс: один контейнер для оферты с возможностью разворота по клику
- Улучшена обработка событий для автообновления оферт

### Исправлено
- Ошибка `'AllegroToken' object has no attribute 'expires_at'` в функции получения токенов
- Убрана зависимость от поля `expires_at` в модели AllegroToken
- Исправлена логика проверки токенов в функции `get_token`
- Добавлено детальное логирование для диагностики API endpoint оферт

## [2024-12-28] - Реализован блок оферт Allegro в управлении товарами
### Добавлено
- Новый API endpoint `/api/products/{sku}/offers/{account_name}` для получения оферт товара по аккаунту Allegro
- Разворачивающийся блок оферт в интерфейсе управления товаром (`product_manage.html`)
- Отображение основной цены оферты до разворота блока
- Детальная информация об оферте при развороте: статистика, остатки, публикация, условия продажи
- Автоматическая загрузка сводки оферт при открытии страницы управления товаром
- Кеширование загруженных оферт для оптимизации

### Изменено
- Обновлен шаблон `product_manage.html` с новым блоком для отображения оферт
- Добавлен JavaScript для интерактивного управления блоками оферт
- Улучшена обработка ошибок при загрузке оферт с возможностью повторной попытки

## [2024-12-28] - Добавлено детальное логирование для диагностики API
### Добавлено
- Детальное логирование в sync_allegro_price_single_product_account для отслеживания данных перед отправкой в API
- Форматирование цены с помощью f"{target_price:.2f}" для избежания научной нотации
- Логирование в AllegroApiService (синхронная и асинхронная версии) для отслеживания точных данных запросов
- Логирование endpoint, данных и заголовков для диагностики ошибок 400 Bad Request

### Изменено
- Улучшена обработка ошибок с более детальным логированием в Celery задаче

## [2024-12-28] - Исправление endpoint для обновления цены оффера
### Исправлено
- Метод `update_offer_price` в AllegroApiService теперь использует правильный endpoint `PUT /sale/offers/{offerId}/change-price-commands/{commandId}` согласно официальной документации Allegro API
- Исправлена структура данных для обновления цены оффера: используется `input.buyNowPrice` вместо `sellingMode.price`
- Добавлена генерация уникального UUID для commandId в каждом запросе
- Синхронная и асинхронная версии метода обновлены для корректной работы с новым endpoint

## [2024-12-28] - Обновление цен для всех найденных офферов
### Изменено
- Функция `sync_allegro_price_single_product_account` теперь обновляет цены для всех найденных офферов, а не только для первого
- Добавлена обработка каждого оффера в цикле с индивидуальным сравнением цен
- Возвращаемый результат содержит информацию о всех обновленных и пропущенных офферах
- Улучшено логирование: показывается количество найденных офферов и результат для каждого

### Добавлено
- Массивы `updated_offers` и `skipped_offers` для детального отслеживания результатов
- Счетчик `offers_processed` для контроля общего количества обработанных офферов
- Логирование количества найденных офферов для каждого SKU

## [2025-07-30] - Полная переработка системы логирования
### Добавлено
- Новая система логирования с фильтрацией технических логов
- Цветной вывод в консоль для разных уровней логирования
- Разделение логов по файлам: app.log (все логи), errors.log (только ошибки)
- Специальные логгеры для бизнес-логики (allegro.sync, wix.api, warehouse, etc.)
- Функции для структурированного логирования: log_business_event, log_error_with_context
- Переменные окружения для управления логированием: LOG_LEVEL, ENABLE_SQL_LOGS
- Фильтр BusinessLogicFilter для исключения SQL запросов и технических деталей
- Документация по новой системе логирования (docs/logging_guide.md)

### Изменено
- Полностью переработан app/utils/logging_config.py с новой архитектурой
- Обновлена конфигурация Celery для уменьшения шума в логах
- Изменен уровень логирования SQLAlchemy в alembic.ini на ERROR
- Обновлены импорты в main.py и celery_app.py для использования новой системы
- Добавлены настройки логирования в example.env

### Исправлено
- Устранен избыточный вывод SQL запросов в консоль
- Скрыты технические логи библиотек (urllib3, httpx, asyncio, etc.)
- Минимизированы логи Celery, Redis, PostgreSQL
- Улучшена читаемость логов для отладки бизнес-процессов

## [2024-12-28] - Отключена конвертация валют
### Изменено
- Закомментирован блок конвертации валют в sync_allegro_price_single_product_account
- Система теперь всегда использует PLN для обновления цен в Allegro
- Всегда используется PLN как валюта для обновления цен в Allegro
- Обновлены логи и возврат результата для использования target_currency

## [2024-12-19] - Механизм обновления цен в Allegro с конвертацией валют

### Добавлено
- Новый метод `update_offer_price` в `SyncAllegroApiService` для обновления цены оффера через PATCH запрос
- Новая Celery задача `sync_allegro_price_single_product_account` для синхронизации цены конкретного товара с конкретным аккаунтом
- Новый API endpoint `/{sku}/sync-settings/{account_name}/sync-price` для ручного запуска синхронизации цены
- Интеграция с `NBPClient` для конвертации цен из PLN в валюту оффера на Allegro
- Автоматическое получение валюты оффера через API Allegro без дополнительных запросов
- Применение мультипликатора цены из настроек синхронизации
- Проверка минимальной разности цен (< 0.01) для избежания ненужных обновлений
- Кнопка "Синхронизировать цену" для каждого аккаунта в интерфейсе управления товаром

### Изменено
- Расширен `SyncAllegroApiService` асинхронной версией метода `update_offer_price`
- Обновлена задача `sync_allegro_price_single_product_account` для полноценной работы с ценами и валютами
- Добавлена валидация наличия минимальной цены у товара перед синхронизацией
- Исправлено получение цены товара через `prices_service` вместо несуществующего поля `min_price` в модели Product

### Исправлено
- Исправлен несуществующий метод `get_sync_settings` в `ProductAllegroSyncService`
- Добавлен синхронный метод `get_account_sync_settings_sync` для использования в Celery задачах
- Исправлены импорты celery в роутере products.py
- Исправлено получение цены товара через `prices_service` во всех компонентах системы

### Техническая информация
- Цены конвертируются из PLN (базовая валюта) в валюту оффера на Allegro
- Используется официальный API Национального банка Польши для получения курсов валют
- Система автоматически определяет валюту оффера из существующих данных в Allegro
- Поддержка точности до 0.01 единицы валюты для корректного сравнения цен
- Обновления цен логируются для отслеживания изменений

## [2024-12-19] - Автоматическая синхронизация при переключении настроек Allegro

### Добавлено
- Автоматический запуск синхронизации остатков при включении настройки `stock_sync_enabled`
- Автоматический запуск синхронизации цен при включении настройки `price_sync_enabled`
- Автоматический запуск синхронизации цен при обновлении мультипликатора цены
- Новая Celery задача `sync_allegro_stock_single_product_account` для синхронизации остатков конкретного товара с конкретным аккаунтом
- Новая Celery задача `sync_allegro_price_single_product_account` для синхронизации цен конкретного товара с конкретным аккаунтом

### Изменено
- Endpoint `/{sku}/sync-settings/{account_name}/toggle-stock` теперь автоматически запускает синхронизацию остатков при включении
- Endpoint `/{sku}/sync-settings/{account_name}/toggle-price` теперь автоматически запускает синхронизацию цен при включении
- Endpoint `/{sku}/sync-settings/{account_name}/update-multiplier` теперь автоматически запускает синхронизацию цен при обновлении мультипликатора

### Техническая информация
- Задачи синхронизации запускаются асинхронно и не блокируют HTTP-ответ
- При ошибке запуска задачи ошибка логируется, но не прерывает выполнение основного запроса
- Задачи проверяют актуальность настроек синхронизации перед выполнением
- Используется существующая инфраструктура `sync_allegro_offers_batch` для реальной синхронизации

## [2024-12-19] - Исправление функции перемещения товаров

### Исправлено
- Исправлена ошибка 422 при перемещении товаров на странице управления товаром
- Заменен неправильный endpoint `/api/warehouse/transfer/` на правильный `/api/warehouse/transfer-item/`
- Удалено поле `comment` из запроса перемещения, так как API его не поддерживает
- Убрано поле для комментария из формы перемещения товаров
- Теперь перемещение товаров работает корректно с правильной моделью данных

### Техническая информация
- Endpoint `/api/warehouse/transfer/` предназначен для загрузки файлов с перемещениями
- Endpoint `/api/warehouse/transfer-item/` предназначен для отдельных перемещений товаров
- Модель `TransferItem` содержит поля: `sku`, `from_warehouse`, `to_warehouse`, `quantity`

## [2024-12-19] - Обновление системы синхронизации остатков с Allegro

### Изменено
- Обновлена архитектура задач синхронизации остатков для учета индивидуальных настроек товаров
- Функция `sync_allegro_stock_single_product` теперь проверяет флаг `stock_sync_enabled` для каждого аккаунта
- Функция `sync_allegro_stock_single_account` получает только товары с включенной синхронизацией для конкретного аккаунта
- Функция `sync_allegro_stock_all_accounts` делегирует логику выбора товаров в `sync_allegro_stock_single_account`
- Функция `sync_allegro_offers_batch` фильтрует SKU по настройкам синхронизации перед обработкой
- Добавлены синхронные версии методов в `ProductAllegroSyncService`: `should_sync_product_sync` и `get_products_for_stock_sync_sync`

### Добавлено
- Интеграция с моделью `ProductAllegroSyncSettings` в задачи синхронизации
- Проверка настроек синхронизации для каждой пары товар-аккаунт перед запуском синхронизации
- Детальное логирование для отслеживания, какие товары синхронизируются с какими аккаунтами
- Обратная совместимость: при отсутствии настроек проверяется флаг `is_sync_enabled` в модели `Product`

### Исправлено
- Устранена проблема запуска синхронизации для всех аккаунтов без учета индивидуальных настроек
- Оптимизирован процесс синхронизации: теперь обрабатываются только товары с включенной синхронизацией
- Улучшена производительность за счет фильтрации товаров на уровне задач

## [2024-01-17] - Переход к минимальной структуре данных для цен

### Изменено
- Полностью переведена система на минимальную структуру данных для цен
- В базе данных: только sku (PRIMARY KEY) и min_price (NUMERIC)
- Удалены поля price, currency, updated_at из всех эндпоинтов и шаблонов
- Заменены price_info.price на price_info.min_price во всех маршрутах
- Упрощена PriceDataResponse: убраны @property методы для совместимости
- Обновлены шаблоны product_card.html и product_manage.html для работы с min_price
- Исправлены JavaScript функции для работы с минимальной структурой
- Валюта теперь фиксированная PLN во всех отображениях

### Исправлено
- Устранены ошибки в логах: "'PriceDataResponse' object has no attribute 'updated_at'"
- Исправлена несогласованность между структурой БД и кодом приложения
- Исправлена логика отображения цены: теперь цена 0 отображается корректно, а "Не указана" показывается только при отсутствии записи в БД
- Изменены условия с `{% if product.min_price %}` на `{% if product.min_price is not none %}` в шаблонах
- Исправлена проблема с редактированием цены в каталоге: перенесены модальное окно и JavaScript функции из product_card.html в catalog.html для избежания конфликтов ID

## [2024-12-20] - Интеграция с удаленной БД цен товаров

### Добавлено
- Создан сервис для работы с удаленной БД цен (`app/services/prices_service.py`)
- Добавлены модели для работы с таблицей `prices_data` (PriceData, PriceDataCreate, PriceDataUpdate, PriceDataResponse)
- Создан класс PricesService с полным интерфейсом для работы с ценами
- Добавлены API роуты для управления ценами (`/api/prices/`)
- Интеграция отображения цен в карточках товаров каталога
- Добавлено редактирование цен администраторами прямо в карточке товара
- Отображение цен на странице управления товаром с возможностью редактирования
- Поддержка валют (PLN по умолчанию) для цен товаров
- Массовые операции с ценами (batch update, import)
- Статистика по ценам (количество, средняя/мин/макс цена)
- Адаптация под реальную структуру таблицы: `sku` (PRIMARY KEY), `min_price` (NUMERIC)

### Улучшено
- Карточки товаров теперь показывают актуальные цены из удаленной БД
- Добавлены модальные окна для редактирования цен администраторами
- Автоматическое обогащение данных о товарах ценами при загрузке каталога
- Graceful fallback при недоступности БД цен

### Техническое описание
- Добавлена конфигурация для подключения к удаленной БД цен (PRICES_DB_URI, PRICES_DB_URI_ASYNC)
- Реализован полный CRUD для работы с ценами через REST API
- Добавлена обработка ошибок и fallback для случаев недоступности БД цен
- Интеграция с существующей архитектурой проекта без breaking changes
- Поддержка как синхронных, так и асинхронных операций с БД цен

## [2024-12-20] - Исправлена функциональность страницы управления товаром

### Исправлено
- Исправлена ошибка SQLAlchemy ArgumentError в модели ProductAllegroSyncSettings
- Устранена проблема с неправильным определением relationship в модели
- Исправлена маршрутизация для страницы управления товаром (/products/{sku}/manage)
- Разделены роутеры: каталог доступен по /catalog, управление товарами по /products/{sku}/manage
- Исправлена логика отображения остатков - теперь показываются все склады, даже с нулевыми остатками
- Исправлены API эндпоинты для тоглов синхронизации (убран лишний /v1 из URL)
- Добавлена кнопка "Применить" для мультипликатора цены вместо автоматического обновления

### Улучшено
- Теперь отображаются все склады из enum Warehouses, даже если для товара нет записей в таблице stock
- Улучшена UX - мультипликатор цены применяется по кнопке, а не автоматически при изменении

### Техническое описание
- Убран неправильный параметр foreign_keys из определения relationship в ProductAllegroSyncSettings
- Создан отдельный catalog_router для каталога без префикса
- Исправлена логика формирования stock_by_warehouse для показа всех складов
- Исправлены URL в JavaScript: заменен /api/v1/ на /api/
- Заменен onchange на кнопку "Применить" для мультипликатора

## [2024-12-20] - Исправлен круговой импорт в модулях Celery

### Исправлено
- Решена проблема кругового импорта между app/celery_app.py, app/services/warehouse/manager.py и app/services/allegro/sync_tasks.py
- Создан отдельный модуль app/celery_shared.py для общих объектов Celery
- Перенесены celery, SessionLocal, get_allegro_token в общий модуль
- Обновлены импорты в зависимых модулях

### Улучшено
- Улучшена архитектура модулей - устранена циклическая зависимость
- Разделены обязанности: celery_shared.py содержит только общие объекты, celery_app.py - только задачи
- Повышена стабильность запуска приложения

### Техническое описание
- Создан app/celery_shared.py с инициализацией celery и общими функциями
- Обновлен app/celery_app.py - убраны общие объекты, оставлены только задачи
- Обновлен app/services/allegro/sync_tasks.py - изменен импорт с celery_app на celery_shared
- Исправлена ImportError: cannot import name 'celery' from partially initialized module

## [2024-12-20] - Исправлена работа совместного использования фильтров по остаткам

### Исправлено
- Исправлена проблема с одновременным использованием фильтров по минимальному и максимальному количеству
- Объединение условий фильтрации в один вызов .having() с логическим AND
- Исправлена логика JavaScript для передачи параметров фильтров на сервер
- Добавлена автоматическая коррекция некорректных значений фильтров (когда max < min)
- Теперь фильтры "Остаток меньше чем" и "Остаток больше чем" работают корректно вместе

### Улучшено
- Улучшен пользовательский интерфейс фильтров: заменены символы "< 999" и "> 999" на понятные "Макс." и "Мин."
- Добавлены математические символы ≤ и ≥ над полями фильтров для лучшего понимания
- Добавлены подсказки (title) для полей фильтров
- Увеличена ширина полей фильтров для лучшего восприятия

### Техническое описание
- Заменены отдельные вызовы .having() на единый вызов с объединенными условиями
- Добавлена логика сбора условий фильтрации в массив having_conditions
- Использование sqlalchemy.and_() для корректного объединения условий
- Исправлен JavaScript код в handleFilterChange() и goToPage() для правильной передачи параметров
- Параметры stock_filter и min_stock_filter теперь отправляются только когда поля заполнены
- Убрана проверка >= 0 в бэкенде, поскольку пустые поля больше не отправляются как -1
- Добавлена валидация параметров фильтров с автоматической коррекцией некорректных значений

## [2024-12-20] - Исправлена ошибка 405 Method Not Allowed в API Allegro и добавлена таблица блокировок
### Исправлено
- Ошибка 405 Method Not Allowed при обновлении остатков офферов Allegro
- Создан новый метод update_offer_stock() использующий правильный API endpoint
- Заменен PATCH запрос на PUT /sale/offer-quantity-change-commands/{commandId}
- Добавлена миграция для создания таблицы productsynclock
- Исправлена ошибка "relation productsynclock does not exist"

### Предыдущие исправления
- TypeError: InventoryManager.__init__() missing 2 required positional arguments: 'dsn' and 'async_dsn'
- Заменен прямой вызов InventoryManager() на get_manager() в sync_tasks.py
- Обновлены импорты для корректной работы с менеджером инвентаря
- Исправлен вызов несуществующего метода get_total_stock() на get_stock_by_sku() с суммированием остатков

### Предыдущие изменения
- Ошибка AttributeError: 'str' object has no attribute 'get' в sync_allegro_offers_batch
- Корректная обработка ответа API get_offers (извлечение списка офферов из ответа)
- Улучшено логирование процесса синхронизации с детальной информацией о типах данных
- Детальное логирование в sync_allegro_offers_batch для отладки
- Проверка типов данных в процессе синхронизации
- Защита от некорректных данных с информативными сообщениями об ошибках
- Логирование каждого этапа обработки офферов

## [2024-12-20] - Добавлены расширенные фильтры каталога товаров
### Добавлено
- Фильтр "Остаток больше чем" для минимального количества товаров
- Отдельный фильтр по бренду через выпадающий список
- API endpoint GET /api/products/brands для получения списка уникальных брендов
- Поддержка параметра brand_filter в эндпоинтах каталога
- Поддержка параметра min_stock_filter в эндпоинтах каталога
- Динамическая загрузка списка брендов при инициализации страницы

### Изменено
- Десктопная версия каталога использует кастомную сетку фильтров с оптимизированными размерами
- Поле поиска максимально расширено для удобства ввода (поиск только по названию, SKU, EAN)
- Поля фильтрации остатков компактные (80px) с символами < и > в плейсхолдерах
- Ограничение ввода до 3 символов для полей остатков с центрированием текста
- Мобильная версия включает новые поля фильтрации с аналогичными изменениями
- JavaScript функции обновлены для поддержки новых фильтров
- Функция getActiveFormElements включает новые поля фильтрации

### Удалено
- Поиск по бренду из строки поиска (теперь только через отдельный фильтр)

## [2024-12-20] - Добавлено поле редактирования бренда товара и поиск по бренду
### Добавлено
- Поле "Бренд" в форму редактирования товара (edit_product.html)
- Обработка параметра brand в API endpoint PUT /api/products/{sku}
- Валидация поля бренда: пустая строка преобразуется в NULL
- Логирование изменений бренда в операциях редактирования товара
- Поиск по полю бренда в каталоге товаров (Product.brand.ilike)

### Изменено
- Форма редактирования товара теперь включает поле для изменения бренда
- API endpoint обновления товара поддерживает изменение бренда
- Данные для формы редактирования включают текущее значение бренда
- Поисковая строка теперь ищет по названию, SKU, EAN и бренду
- Обновлены placeholder'ы в поисковых полях каталога

## [2024-12-20] - Добавлена синхронизация одного товара по всем аккаунтам Allegro
### Добавлено
- Celery задача sync_allegro_stock_single_product для синхронизации одного товара по всем аккаунтам
- API endpoint POST /api/products/{sku}/sync-allegro для запуска синхронизации товара
- Кнопка "Синхронизировать" в карточке товара для ручного запуска синхронизации
- JavaScript функция syncProductAllegro для обработки клика на кнопку синхронизации
- Проверка существования товара в БД перед синхронизацией
- Проверка флага is_sync_enabled для товара перед синхронизацией
- Обновлено описание файла sync_tasks.py для отражения новой функциональности

### Изменено
- Обновлены dependencies в описании модуля sync_tasks.py
- Улучшена структура блока синхронизации в карточке товара
- Кнопка синхронизации отображается только при включенном флаге is_sync_enabled

## [2024-12-20] - Реализация UI управления синхронизацией товаров
### Добавлено
- Подпись "Allegro:" перед toggle переключателем синхронизации
- Подробный tooltip с описанием функции синхронизации
- API endpoint PATCH /api/products/{sku}/sync-flag для переключения флага синхронизации
- Новый тип операции PRODUCT_SYNC_TOGGLE для логирования изменений флага
- Метод create_product_sync_toggle_operation в OperationsService
- JavaScript функция toggleSyncFlag с обновлением UI в реальном времени

### Изменено
- Улучшен UI карточки товара: добавлена подпись и детальный tooltip
- Обновлена структура toggle элементов для лучшей читаемости

## [2024-06-13] - Этапы реализации автоматической синхронизации остатков с Allegro
### Завершено
- Реализован пайплайн Celery задач для массовой синхронизации остатков
- Добавлен rate limiter для соблюдения лимитов API Allegro
- Реализована система уведомлений об ошибках в Telegram
- Добавлено детальное логирование и мониторинг
- Добавлен булевый флаг is_sync_enabled в модель товара и миграция

### В процессе
- Обновление бизнес-логики синхронизации: сначала is_sync_enabled, затем логи с локами
- Реализация и интеграция механизма блокировок (локов) для защиты от дублирующихся обновлений по SKU

### Запланировано
- Кнопка в UI карточки товара для ручного включения/отключения синхронизации
- Интеграция задачи в планировщик Celery Beat 

## [2024-12-19] - Переработка системы синхронизации товаров с Allegro
### Добавлено
- Новая модель `ProductAllegroSyncSettings` для индивидуальных настроек синхронизации по аккаунтам
- Страница управления товаром `/products/{sku}/manage` с детальными настройками синхронизации
- API эндпоинты для управления настройками синхронизации:
  - `POST /api/v1/products/{sku}/sync-settings` - создание/обновление настроек
  - `GET /api/v1/products/{sku}/sync-settings` - получение всех настроек
  - `POST /api/v1/products/{sku}/sync-settings/{account_name}/toggle-stock` - переключение синхронизации остатков
  - `POST /api/v1/products/{sku}/sync-settings/{account_name}/toggle-price` - переключение синхронизации цен
  - `POST /api/v1/products/{sku}/sync-settings/{account_name}/update-multiplier` - обновление мультипликатора цены
- Возможность настройки мультипликатора цены для каждого аккаунта Allegro отдельно
- Отдельные настройки синхронизации остатков и цен для каждого аккаунта
- Красивый интерфейс управления настройками синхронизации с переключателями и полями ввода

### Изменено
- Заменен тогл синхронизации на кнопку "Управление" в карточке товара
- Админы получают кнопку "Управление", обычные пользователи - кнопку "Просмотр"
- Настройки синхронизации теперь глобальные для всех пользователей системы
- Упрощена архитектура - убрана привязка к пользователю в настройках

### Удалено
- Старый JavaScript код для тогла синхронизации в product_card.html
- Зависимость от прямой привязки к токену в модели настроек

### Техническая информация
- Модель `ProductAllegroSyncSettings` использует составной ключ `product_sku + allegro_account_name`
- Подготовлена архитектура для будущего перехода на микросервисную систему
- Сохранена обратная совместимость с существующим полем `is_sync_enabled` в модели Product 

## [2024-12-30] - Исправление ссылок в уведомлениях о валидации заказов
### Исправлено
- Исправлены ссылки в Telegram уведомлениях о провале валидации заказов
- Теперь используется правильная ссылка на детали операции через operation_id вместо order_id
- Улучшено форматирование ссылок в HTML формате для лучшего отображения в Telegram

### Изменено
- Обновлен метод `notify_order_validation_failure` в `StockSyncNotificationService`
- Ссылки теперь ведут на страницу деталей операции (`/stock-sync/monitor/operation/{operation_id}`)
- Добавлен fallback на мониторинг по order_id, если operation_id недоступен