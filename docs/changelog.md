## [2024-03-12] - Начало работы над интеграцией с Wix API
### Добавлено
- Базовая структура WixApiService для работы с API Wix
- Документация по задачам интеграции с Wix

### Изменено
- Обновлен tasktracker.md с новыми задачами по интеграции

### Планируется
- Реализация методов для работы с товарами (получение по SKU, обновление стока)
- Интеграция с основным потоком данных Allegro -> Wix 

## [2024-03-19] - Реализация работы с инвентарем Wix
### Добавлено
- Модели для работы с инвентарем Wix (WixInventoryVariant, WixPreorderInfo, WixInventoryItem и др.)
- Метод query_inventory для получения информации об инвентаре
- Метод update_inventory для обновления количества товаров
- Документация по работе с инвентарем в project.md

### Изменено
- Обновлена структура WixApiService для поддержки работы с инвентарем
- Улучшена обработка ошибок при работе с API

### Планируется
- Добавление тестов для методов работы с инвентарем
- Реализация массового обновления инвентаря
- Добавление кэширования для оптимизации запросов

## [2024-03-19] - Улучшение работы с API Wix
### Добавлено
- Реализованы высокоуровневые методы для получения всех товаров и инвентарей с учетом ограничений API
- Добавлена поддержка фильтрации для товаров и инвентарей
- Добавлены модели фильтров `WixProductFilter` и `WixInventoryFilter`
- Реализована постраничная загрузка данных с автоматической обработкой лимитов API

### Изменено
- Улучшена валидация данных в моделях инвентаря
- Оптимизирована обработка ошибок при работе с API
- Добавлено подробное логирование для отладки
- Улучшена обработка алиасов полей в моделях

### Исправлено
- Исправлена валидация вариантов товаров в инвентаре
- Исправлена обработка preorder_info в моделях
- Исправлена обработка метаданных в ответах API
- Исправлена работа с алиасами полей в моделях 

## [2024-03-21] - Добавлен метод получения офферов Allegro
### Добавлено
- Новый метод `get_offers` в `SyncAllegroApiService` и `AsyncAllegroApiService` для получения списка офферов с фильтрацией
- Поддержка фильтрации по external.id с валидацией длины
- Поддержка пагинации и сортировки результатов
- Поддержка фильтрации по статусу публикации и маркетплейсу 

## [2024-03-21] - Миграция хранения ID последних событий Allegro с Redis на PostgreSQL
### Изменено
- Создана новая модель `AllegroEventTracker` для хранения ID последних событий Allegro
- Добавлен репозиторий `AllegroEventTrackerRepository` для работы с моделью
- Модифицирована задача `process_allegro_order_events` для использования PostgreSQL вместо Redis
- Удалена зависимость от Redis для хранения ID последних событий

### Технические детали
- Новая таблица `allegro_event_trackers` содержит поля:
  - `id` (PK)
  - `token_id` (unique, indexed)
  - `last_event_id`
  - `created_at`
  - `updated_at`

## [2024-03-21] - Создание задачи для реализации редактирования товаров
### Добавлено
- Создана новая задача в tasktracker.md для реализации функциональности редактирования товаров
- Проанализирована текущая архитектура API для понимания требований к реализации

### Планируется
- Реализация API эндпоинта для обновления товаров (PUT/PATCH)
- Создание веб-интерфейса для редактирования товаров
- Добавление валидации данных при редактировании
- Интеграция с системой логирования операций
- Обновление Telegram бота для поддержки редактирования товаров

## [2024-03-21] - Создание моделей для редактирования товаров
### Добавлено
- Создан файл `app/schemas/product.py` с Pydantic схемами для работы с продуктами
- Добавлены схемы: `ProductBase`, `ProductCreate`, `ProductUpdate`, `ProductResponse`, `ProductEditForm`, `ProductUpdateRequest`, `ProductEditOperation`
- Добавлен новый тип операции `PRODUCT_EDIT` в `OperationType` enum
- Реализован метод `create_product_edit_operation` в `OperationsService` для логирования изменений
- Обновлен `app/schemas/__init__.py` для экспорта новых схем

### Технические детали
- Валидация EAN кодов с поддержкой множественных кодов через запятую
- Валидация формата SKU (буквы, цифры, дефисы, подчеркивания)
- Поддержка частичного обновления через `ProductUpdate` схему
- Интеграция с системой логирования операций для отслеживания изменений
- Подготовка для работы с изображениями в формате Base64

## [2024-03-21] - Реализация API эндпоинтов и веб-интерфейса для редактирования товаров
### Добавлено
- Реализован API эндпоинт `PUT /api/products/{sku}` для обновления товаров
- Создан веб-эндпоинт `GET /products/{sku}/edit` для отображения формы редактирования
- Создан HTML шаблон `edit_product.html` с формой редактирования товара
- Добавлена кнопка "Редактировать" в карточки товаров для администраторов
- Реализована JavaScript функция `editProduct()` для перехода к редактированию

### Технические детали
- Поддержка обновления названия, SKU, EAN и изображения товара
- Валидация уникальности SKU при изменении
- Обработка изображений с оптимизацией (WebP, 100x100px)
- Предпросмотр текущего и нового изображения
- Интеграция с системой логирования операций
- Проверка прав доступа (только администраторы)
- Автоматическое перенаправление на каталог после сохранения

## [2024-03-21] - Реализация каскадных операций в базе данных
### Добавлено
- Реализовано каскадное удаление и обновление для связанных таблиц (Stock, Sale, Transfer) при изменении или удалении товара
- Созданы миграции Alembic для добавления каскадных ограничений в базе данных
- Обновлены модели SQLModel с использованием правильных параметров для каскадных операций

### Изменено
- Обновлена модель `Product` с добавлением SQLModel Relationship с параметрами `sa_relationship_kwargs={"cascade": "all, delete-orphan"}`
- Обновлены модели `Stock`, `Sale`, `Transfer` с добавлением ForeignKey с параметрами `ondelete="CASCADE"` и `onupdate="CASCADE"`
- Исправлены параметры в моделях для корректной генерации миграций Alembic

### Технические детали
- Использование SQLModel Relationship для автоматического каскадного удаления связанных записей
- Настройка ForeignKey с каскадными ограничениями на уровне базы данных
- Генерация миграций для добавления каскадных ограничений в существующие таблицы
- Подготовка к применению миграций для активации каскадных операций 

## [2024-03-21] - Кастомное отображение операций редактирования товара
### Изменено
- Для операций типа PRODUCT_EDIT теперь отображается "Склад: —"
- Выводится список изменённых полей с отображением старого и нового значения
- Улучшена информативность истории операций для администраторов 

## [2024-03-21] - Анализ стадии задачи по обновлению остатков на Wix
### Анализ текущего состояния
- **Реализованная функциональность (70% завершено)**:
  - ✅ Полная базовая структура WixApiService с методами работы с API Wix
  - ✅ Методы получения товаров по SKU с поддержкой пагинации
  - ✅ Методы работы с инвентарем: query_inventory, update_inventory
  - ✅ Высокоуровневые методы для получения всех товаров и инвентарей
  - ✅ Поддержка фильтрации и постраничной загрузки данных
  - ✅ Валидация данных через SQLModel с обработкой алиасов полей
  - ✅ Обработка ошибок API с детальным логированием
  - ✅ Модели данных для работы с инвентарем (WixInventoryVariant, WixInventoryItem и др.)

### Критические пробелы в реализации
- ❌ **Отсутствует интеграция с основным потоком данных**:
  - WixApiService не используется в процессе обработки заказов Allegro
  - Нет автоматического обновления остатков в Wix при списании товаров
  - Отсутствует синхронизация между локальной базой данных и Wix
  - Процесс списания товаров (AllegroStockService) работает только с локальной базой

### Текущий процесс списания товаров
1. **AllegroStockService.process_order_stock_update()** - списывает товары только из локальной базы
2. **InventoryManager.remove_as_sale()** - обновляет таблицы Stock в PostgreSQL
3. **Отсутствует этап** - обновление остатков в Wix через WixApiService

### Рекомендации по завершению интеграции
1. **Интеграция WixApiService в AllegroStockService**:
   - Добавить WixApiService в конструктор AllegroStockService
   - После успешного списания из локальной базы обновлять остатки в Wix
   - Обрабатывать ошибки API Wix отдельно от ошибок локальной базы

2. **Создание сервиса синхронизации**:
   - Реализовать WixInventorySyncService для массовой синхронизации
   - Добавить механизм отложенной синхронизации через Celery
   - Реализовать обработку конфликтов данных

3. **Тестирование и оптимизация**:
   - Написать unit-тесты для методов работы с инвентарем
   - Добавить интеграционные тесты с реальным API Wix
   - Реализовать кэширование и механизм повторных попыток

### Планируемые следующие шаги
- [ ] Интеграция WixApiService в процесс списания товаров
- [ ] Создание сервиса синхронизации остатков
- [ ] Написание тестов для новой функциональности
- [ ] Оптимизация производительности и надежности

## [2024-03-21] - Создание архитектурного решения для централизованного управления остатками
### Добавлено
- Разработана полная архитектура системы централизованного управления остатками
- Созданы модели данных для интеграции с множественными аккаунтами маркетплейсов
- Разработаны сервисы для синхронизации остатков между PostgreSQL, Wix и Allegro
- Добавлена поддержка множественных аккаунтов Wix с индивидуальными креденшиалами

### Архитектурные решения
1. **Централизованная модель данных**:
   - `WixAccount` - управление аккаунтами Wix
   - `WixProductMapping` - связь товаров с Wix аккаунтами
   - `WixInventorySync` - история синхронизации остатков
   - `MarketplaceAccount` - базовый класс для будущих маркетплейсов

2. **Сервисы синхронизации**:
   - `InventorySyncService` - централизованная синхронизация остатков
   - `WixAccountService` - управление аккаунтами и маппингами
   - Интеграция с существующим `AllegroStockService`

## [2025-01-03] - Добавление подробного логирования для отладки ошибок Allegro API
### Добавлено
- Подробное логирование в методы `get_order_events_statistics` и `get_order_events_v2` в `AllegroApiService`
- Детальное логирование процесса обработки событий заказов в `celery_app.py`
- Проверка структуры ответов API с валидацией полей

### Изменено
- Улучшена обработка ошибок при работе с API Allegro
- Добавлены проверки на пустые ответы и отсутствующие поля
- Улучшена диагностика проблем с токенами доступа

### Исправлено
- Исправлена потенциальная ошибка `'NoneType' object has no attribute 'get'` при обработке статистики событий
- Добавлена защита от некорректных ответов API

## [2025-01-05] - Улучшение стабильности Wix API и замена print на логирование
### Добавлено
- Подробное логирование всех запросов к Wix API с детальной информацией об ошибках
- Механизм повторных попыток для обработки временных ошибок API
- Валидация SKU перед отправкой запросов
- Ограничение размера батча до 50 элементов для повышения стабильности

### Изменено
- Заменены все `print` на соответствующие уровни логирования (`logger.info`, `logger.error`, `logger.debug`)
- Улучшена обработка ошибок HTTP 500 от Wix API
- Добавлена экспоненциальная задержка между повторными попытками

### Исправлено
- Потенциальные проблемы с большими батчами SKU, вызывающими ошибки 500
- Улучшена диагностика проблем с API Wix

3. **Автоматизация процессов**:
   - Автоматическая синхронизация при списании товаров
   - Периодическая синхронизация всех остатков через Celery
   - Отслеживание истории синхронизации с детальным логированием

### Ключевые преимущества архитектуры
- **PostgreSQL как источник правды** - все остатки контролируются централизованно
- **Масштабируемость** - легко добавлять новые маркетплейсы и аккаунты
- **Надежность** - обработка ошибок, повторные попытки, детальное логирование
- **Производительность** - асинхронная обработка, кэширование сервисов
- **Отслеживаемость** - полная история всех операций синхронизации

### Планируемые следующие шаги
- [ ] Создание миграций для новых таблиц
- [ ] Реализация сервисов InventorySyncService и WixAccountService
- [ ] Интеграция с существующим AllegroStockService
- [ ] Создание Celery задач для периодической синхронизации
- [ ] Разработка API эндпоинтов для управления аккаунтами
- [ ] Создание веб-интерфейса для мониторинга синхронизации 

## [2024-12-19] - Создание метода для получения информации о товарах в Wix

### Добавлено
- Новый метод `get_wix_products_info_by_sku_list()` для получения детальной информации о товарах в Wix
- Возвращает словарь {sku: {product_id, variant_id, current_quantity, inventory_item_id}}
- Поддержка обработки списков SKU любой длины с автоматическим разбиением на батчи
- Детальное логирование процесса получения информации
- Тестовый скрипт `test_wix_info_method.py` для проверки функциональности

### Изменено
- Расширена функциональность WixApiService для работы с информацией о товарах
- Улучшена документация API методов

### Исправлено
- Оптимизирована обработка больших списков SKU
- Улучшена обработка ошибок при получении информации о товарах

### Технические детали
- Возвращает структурированную информацию о каждом товаре
- Использует первый вариант товара для получения variant_id и current_quantity
- Поддерживает батчевую обработку для эффективной работы с API
- Сохраняет результат в JSON файл для анализа

## [2024-12-19] - Улучшение методов синхронизации с Wix для больших объемов данных

### Добавлено
- Новый метод `get_inventory_updates_by_sku_list()` для получения готовых моделей WixInventoryUpdate из списка SKU любой длины
- Новый метод `update_inventory_by_sku_list()` для обновления инвентаря по словарю {sku: quantity}
- Автоматическая обработка батчей с учетом ограничений API (максимум 100 элементов)
- Улучшенная логика сопоставления SKU с inventory_item_id через product_id
- Автоматическое получение variant_id первого варианта для каждого товара
- Детальное логирование процесса обработки батчей

### Изменено
- Обновлена Celery задача `sync_wix_inventory` для использования новых методов
- Упрощена логика синхронизации - теперь используется один вызов метода вместо множественных операций
- Улучшена производительность за счет батчевой обработки и оптимизации API вызовов

### Исправлено
- Решена проблема с ограничением API в 100 элементов на запрос
- Исправлена логика сопоставления SKU с inventory_item_id
- Улучшена обработка ошибок при работе с большими объемами данных

### Технические детали
- Поддержка обработки до 1000+ SKU за один запуск
- Автоматическое разбиение на батчи по 100 элементов
- Использование increment/decrement API для точного обновления количеств
- Оптимизированные API вызовы с минимальным количеством запросов

## [2024-12-19] - Создание Celery задачи для синхронизации количества товаров с Wix

### Добавлено
- Новая Celery задача `sync_wix_inventory` для синхронизации количества товаров между локальной базой данных и Wix
- Функция получения всех SKU и их количества из базы данных
- Функция поиска соответствующих товаров в Wix по SKU
- Функция обновления количества товаров в Wix через API
- Логирование процесса синхронизации с детальной информацией
- API эндпоинты для ручного запуска синхронизации (`POST /warehouse/sync-wix/`)
- API эндпоинт для проверки статуса синхронизации (`GET /warehouse/sync-wix/status/{task_id}`)
- Автоматическое выполнение задачи каждый час через Celery Beat
- Функция `launch_wix_sync()` для программного запуска синхронизации
- Тестовый скрипт `test_wix_sync.py` для проверки функциональности
- Подробное руководство по использованию в `docs/wix_sync_guide.md`

### Изменено
- Обновлена документация проекта с описанием новой функциональности
- Добавлена задача в `DEFAULT_BEAT_SCHEDULE` для автоматического запуска
- Расширен роутер warehouse.py новыми эндпоинтами

### Исправлено
- Улучшена обработка ошибок при работе с Wix API
- Добавлена батчевая обработка обновлений для избежания превышения лимитов API
- Реализована безопасная логика обновления через increment/decrement

### Технические детали
- Использует существующий `WixApiService` для работы с API
- Интегрируется с моделями `Product` и `Stock` из warehouse
- Поддерживает обработку до 1000 товаров за раз
- Включает детальную статистику выполнения
- Обеспечивает отказоустойчивость при ошибках API

## [2024-12-19] - Исправление ошибок API и оптимизация групповых обновлений

### Исправлено
- Исправлена ошибка 400 Bad Request при обновлении инвентаря в Wix
- Исправлен формат данных для API increment/decrement - добавлен обязательный параметр variantId
- Убрана избыточная проверка наличия variant_id в update_inventory

### Оптимизировано
- Изменена логика Celery задачи sync_wix_inventory для групповой обработки обновлений
- Вместо отдельных запросов для каждого товара теперь отправляются групповые запросы:
  - Один запрос для всех инкрементов
  - Один запрос для всех декрементов
- Значительно уменьшено количество API запросов к Wix (с N до максимум 2)

### Технические детали
- Обновлен метод update_inventory для правильного форматирования данных API
- Добавлено детальное логирование отправляемых данных
- Улучшена обработка ошибок с более информативными сообщениями
- Сохранена совместимость с существующими моделями данных 