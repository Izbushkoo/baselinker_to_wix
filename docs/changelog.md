## [2024-12-20] - Исправлен круговой импорт в модулях Celery

### Исправлено
- Решена проблема кругового импорта между app/celery_app.py, app/services/warehouse/manager.py и app/services/allegro/sync_tasks.py
- Создан отдельный модуль app/celery_shared.py для общих объектов Celery
- Перенесены celery, SessionLocal, get_allegro_token в общий модуль
- Обновлены импорты в зависимых модулях

### Улучшено
- Улучшена архитектура модулей - устранена циклическая зависимость
- Разделены обязанности: celery_shared.py содержит только общие объекты, celery_app.py - только задачи
- Повышена стабильность запуска приложения

### Техническое описание
- Создан app/celery_shared.py с инициализацией celery и общими функциями
- Обновлен app/celery_app.py - убраны общие объекты, оставлены только задачи
- Обновлен app/services/allegro/sync_tasks.py - изменен импорт с celery_app на celery_shared
- Исправлена ImportError: cannot import name 'celery' from partially initialized module

## [2024-12-20] - Исправлена работа совместного использования фильтров по остаткам

### Исправлено
- Исправлена проблема с одновременным использованием фильтров по минимальному и максимальному количеству
- Объединение условий фильтрации в один вызов .having() с логическим AND
- Исправлена логика JavaScript для передачи параметров фильтров на сервер
- Добавлена автоматическая коррекция некорректных значений фильтров (когда max < min)
- Теперь фильтры "Остаток меньше чем" и "Остаток больше чем" работают корректно вместе

### Улучшено
- Улучшен пользовательский интерфейс фильтров: заменены символы "< 999" и "> 999" на понятные "Макс." и "Мин."
- Добавлены математические символы ≤ и ≥ над полями фильтров для лучшего понимания
- Добавлены подсказки (title) для полей фильтров
- Увеличена ширина полей фильтров для лучшего восприятия

### Техническое описание
- Заменены отдельные вызовы .having() на единый вызов с объединенными условиями
- Добавлена логика сбора условий фильтрации в массив having_conditions
- Использование sqlalchemy.and_() для корректного объединения условий
- Исправлен JavaScript код в handleFilterChange() и goToPage() для правильной передачи параметров
- Параметры stock_filter и min_stock_filter теперь отправляются только когда поля заполнены
- Убрана проверка >= 0 в бэкенде, поскольку пустые поля больше не отправляются как -1
- Добавлена валидация параметров фильтров с автоматической коррекцией некорректных значений

## [2024-12-20] - Исправлена ошибка 405 Method Not Allowed в API Allegro и добавлена таблица блокировок
### Исправлено
- Ошибка 405 Method Not Allowed при обновлении остатков офферов Allegro
- Создан новый метод update_offer_stock() использующий правильный API endpoint
- Заменен PATCH запрос на PUT /sale/offer-quantity-change-commands/{commandId}
- Добавлена миграция для создания таблицы productsynclock
- Исправлена ошибка "relation productsynclock does not exist"

### Предыдущие исправления
- TypeError: InventoryManager.__init__() missing 2 required positional arguments: 'dsn' and 'async_dsn'
- Заменен прямой вызов InventoryManager() на get_manager() в sync_tasks.py
- Обновлены импорты для корректной работы с менеджером инвентаря
- Исправлен вызов несуществующего метода get_total_stock() на get_stock_by_sku() с суммированием остатков

### Предыдущие изменения
- Ошибка AttributeError: 'str' object has no attribute 'get' в sync_allegro_offers_batch
- Корректная обработка ответа API get_offers (извлечение списка офферов из ответа)
- Улучшено логирование процесса синхронизации с детальной информацией о типах данных
- Детальное логирование в sync_allegro_offers_batch для отладки
- Проверка типов данных в процессе синхронизации
- Защита от некорректных данных с информативными сообщениями об ошибках
- Логирование каждого этапа обработки офферов

## [2024-12-20] - Добавлены расширенные фильтры каталога товаров
### Добавлено
- Фильтр "Остаток больше чем" для минимального количества товаров
- Отдельный фильтр по бренду через выпадающий список
- API endpoint GET /api/products/brands для получения списка уникальных брендов
- Поддержка параметра brand_filter в эндпоинтах каталога
- Поддержка параметра min_stock_filter в эндпоинтах каталога
- Динамическая загрузка списка брендов при инициализации страницы

### Изменено
- Десктопная версия каталога использует кастомную сетку фильтров с оптимизированными размерами
- Поле поиска максимально расширено для удобства ввода (поиск только по названию, SKU, EAN)
- Поля фильтрации остатков компактные (80px) с символами < и > в плейсхолдерах
- Ограничение ввода до 3 символов для полей остатков с центрированием текста
- Мобильная версия включает новые поля фильтрации с аналогичными изменениями
- JavaScript функции обновлены для поддержки новых фильтров
- Функция getActiveFormElements включает новые поля фильтрации

### Удалено
- Поиск по бренду из строки поиска (теперь только через отдельный фильтр)

## [2024-12-20] - Добавлено поле редактирования бренда товара и поиск по бренду
### Добавлено
- Поле "Бренд" в форму редактирования товара (edit_product.html)
- Обработка параметра brand в API endpoint PUT /api/products/{sku}
- Валидация поля бренда: пустая строка преобразуется в NULL
- Логирование изменений бренда в операциях редактирования товара
- Поиск по полю бренда в каталоге товаров (Product.brand.ilike)

### Изменено
- Форма редактирования товара теперь включает поле для изменения бренда
- API endpoint обновления товара поддерживает изменение бренда
- Данные для формы редактирования включают текущее значение бренда
- Поисковая строка теперь ищет по названию, SKU, EAN и бренду
- Обновлены placeholder'ы в поисковых полях каталога

## [2024-12-20] - Добавлена синхронизация одного товара по всем аккаунтам Allegro
### Добавлено
- Celery задача sync_allegro_stock_single_product для синхронизации одного товара по всем аккаунтам
- API endpoint POST /api/products/{sku}/sync-allegro для запуска синхронизации товара
- Кнопка "Синхронизировать" в карточке товара для ручного запуска синхронизации
- JavaScript функция syncProductAllegro для обработки клика на кнопку синхронизации
- Проверка существования товара в БД перед синхронизацией
- Проверка флага is_sync_enabled для товара перед синхронизацией
- Обновлено описание файла sync_tasks.py для отражения новой функциональности

### Изменено
- Обновлены dependencies в описании модуля sync_tasks.py
- Улучшена структура блока синхронизации в карточке товара
- Кнопка синхронизации отображается только при включенном флаге is_sync_enabled

## [2024-12-20] - Реализация UI управления синхронизацией товаров
### Добавлено
- Подпись "Allegro:" перед toggle переключателем синхронизации
- Подробный tooltip с описанием функции синхронизации
- API endpoint PATCH /api/products/{sku}/sync-flag для переключения флага синхронизации
- Новый тип операции PRODUCT_SYNC_TOGGLE для логирования изменений флага
- Метод create_product_sync_toggle_operation в OperationsService
- JavaScript функция toggleSyncFlag с обновлением UI в реальном времени

### Изменено
- Улучшен UI карточки товара: добавлена подпись и детальный tooltip
- Обновлена структура toggle элементов для лучшей читаемости

## [2024-06-13] - Этапы реализации автоматической синхронизации остатков с Allegro
### Завершено
- Реализован пайплайн Celery задач для массовой синхронизации остатков
- Добавлен rate limiter для соблюдения лимитов API Allegro
- Реализована система уведомлений об ошибках в Telegram
- Добавлено детальное логирование и мониторинг
- Добавлен булевый флаг is_sync_enabled в модель товара и миграция

### В процессе
- Обновление бизнес-логики синхронизации: сначала is_sync_enabled, затем логи с локами
- Реализация и интеграция механизма блокировок (локов) для защиты от дублирующихся обновлений по SKU

### Запланировано
- Кнопка в UI карточки товара для ручного включения/отключения синхронизации
- Интеграция задачи в планировщик Celery Beat 