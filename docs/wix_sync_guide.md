# Руководство по синхронизации с Wix

## Обзор

Система синхронизации с Wix автоматически обновляет количество товаров в Wix магазине в соответствии с остатками в локальной базе данных. Поддерживает обработку больших объемов данных (1000+ SKU) с автоматическим разбиением на батчи.

## Как это работает

### Процесс синхронизации

1. **Получение данных из локальной базы**
   - Система получает все товары с остатками > 0
   - Вычисляет суммарное количество по всем складам для каждого SKU

2. **Обработка SKU батчами**
   - Разбивает список SKU на батчи по 100 элементов (ограничение API)
   - Для каждого батча получает товары из Wix по SKU
   - Получает информацию об инвентаре для найденных товаров

3. **Создание моделей обновления**
   - Создает модели `WixInventoryUpdate` с `inventory_item_id` и `variant_id`
   - Использует `variant_id` первого варианта для каждого товара
   - Сопоставляет SKU с `inventory_item_id` через `product_id`

4. **Обновление количества**
   - Получает текущие количества из Wix для каждого элемента
   - Вычисляет разницу между целевым и текущим количеством
   - Использует increment/decrement API для точного обновления

### Автоматическое выполнение

- Задача выполняется автоматически каждый час
- Запускается через Celery Beat Scheduler
- Логируется в стандартные логи приложения

## API эндпоинты

### Запуск синхронизации

```http
POST /warehouse/sync-wix/
```

**Ответ:**
```json
{
  "status": "success",
  "message": "Синхронизация с Wix запущена",
  "task_id": "abc123-def456-ghi789",
  "task_status": "PENDING"
}
```

### Проверка статуса

```http
GET /warehouse/sync-wix/status/{task_id}
```

**Ответ:**
```json
{
  "task_id": "abc123-def456-ghi789",
  "status": "SUCCESS",
  "ready": true,
  "result": {
    "status": "success",
    "message": "Синхронизация завершена",
    "total_products": 150,
    "found_in_wix": 120,
    "updated_in_wix": 45,
    "errors": 2,
    "details": {
      "local_products_with_stock": 150,
      "wix_products_found": 120,
      "updates_prepared": 47,
      "updates_executed": 45
    }
  }
}
```

## Мониторинг

### Логи

Синхронизация логируется с детальной информацией:

```
INFO: Начало синхронизации количества товаров с Wix
INFO: Получение товаров из локальной базы данных...
INFO: Найдено 150 товаров с остатками в локальной базе
INFO: Получен список из 150 SKU для поиска в Wix
INFO: Поиск товаров в Wix...
INFO: Найдено 120 товаров в Wix
INFO: Подготовлено обновление для SKU123: 10 -> 15
INFO: Выполнение 47 обновлений в Wix...
INFO: Обновлен товар item_456: +5
INFO: Синхронизация завершена: {...}
```

### Статистика выполнения

Каждое выполнение возвращает детальную статистику:

- `total_products` - Общее количество товаров с остатками в локальной базе
- `found_in_wix` - Количество товаров, найденных в Wix
- `updated_in_wix` - Количество успешно обновленных товаров
- `errors` - Количество ошибок при обработке

## Настройка

### Расписание

Задача настроена на выполнение каждый час. Для изменения расписания отредактируйте `DEFAULT_BEAT_SCHEDULE` в `app/celery_app.py`:

```python
'sync-wix-inventory': {
    'task': 'app.celery_app.sync_wix_inventory',
    'schedule': 3600,  # 1 час (в секундах)
},
```

### Конфигурация Wix API

Настройки API находятся в `WixApiService`:

- API ключ
- Site ID
- Account ID
- Base URL

## Устранение неполадок

### Частые ошибки

1. **Товар не найден в Wix**
   - Проверьте, что SKU в локальной базе соответствует SKU в Wix
   - Убедитесь, что товар активен в Wix

2. **Ошибки API**
   - Проверьте валидность API ключа
   - Убедитесь в наличии прав на обновление инвентаря

3. **Превышение лимитов API**
   - Система автоматически разбивает обновления на батчи
   - При необходимости увеличьте интервал между синхронизациями

### Отладка

Для отладки используйте тестовый скрипт:

```bash
python test_wix_sync.py
```

Этот скрипт проверит:
- Подключение к Wix API
- Поиск товаров по SKU
- Запуск Celery задачи
- Доступность API эндпоинтов

## Безопасность

- Все API вызовы требуют авторизации
- Используются безопасные методы обновления (increment/decrement)
- Ошибки логируются без раскрытия чувствительных данных
- Поддерживается откат изменений при ошибках

## Производительность

- Обработка до 1000 товаров за раз
- Батчевая обработка обновлений (50 товаров в батче)
- Асинхронное выполнение через Celery
- Кэширование результатов поиска товаров

## Расширение функциональности

### Добавление новых полей

Для синхронизации дополнительных полей (цена, описание и т.д.):

1. Расширьте модель `WixProductUpdate`
2. Добавьте логику сравнения полей
3. Используйте метод `update_product` для обновления

### Фильтрация товаров

Для синхронизации только определенных товаров:

1. Добавьте параметры фильтрации в задачу
2. Модифицируйте SQL запрос для получения товаров
3. Передавайте фильтры в API вызовы

### Уведомления

Для получения уведомлений о результатах синхронизации:

1. Интегрируйте с Telegram сервисом
2. Добавьте отправку email уведомлений
3. Создайте веб-хуки для внешних систем

## Новые методы API

### get_wix_products_info_by_sku_list()

Получает детальную информацию о товарах в Wix по списку SKU.

```python
from app.services.wix_api_service.base import WixApiService

wix_service = WixApiService()
sku_list = ["SKU1", "SKU2", "SKU3", ...]  # Любое количество SKU
products_info = wix_service.get_wix_products_info_by_sku_list(sku_list, batch_size=100)

# Результат: Dict[str, Dict[str, Any]]
for sku, info in products_info.items():
    print(f"SKU: {sku}")
    print(f"  product_id: {info['product_id']}")
    print(f"  variant_id: {info['variant_id']}")
    print(f"  current_quantity: {info['current_quantity']}")
    print(f"  inventory_item_id: {info['inventory_item_id']}")
```

**Возвращаемая структура:**
```json
{
  "SKU1": {
    "product_id": "prod_123",
    "variant_id": "var_456",
    "current_quantity": 10,
    "inventory_item_id": "inv_789"
  },
  "SKU2": {
    "product_id": "prod_124",
    "variant_id": "var_457",
    "current_quantity": 5,
    "inventory_item_id": "inv_790"
  }
}
```

### get_inventory_updates_by_sku_list() 