## Задача: Автоматическая синхронизация при переключении настроек Allegro
- **Статус**: Завершена
- **Описание**: Добавление автоматического запуска синхронизации остатков и цен при переключении соответствующих настроек
- **Шаги выполнения**:
  - [x] Создать задачу `sync_allegro_stock_single_product_account` для синхронизации остатков конкретного товара с конкретным аккаунтом
  - [x] Создать задачу `sync_allegro_price_single_product_account` для синхронизации цен конкретного товара с конкретным аккаунтом
  - [x] Добавить автоматический запуск синхронизации в endpoint `toggle-stock` при включении настройки
  - [x] Добавить автоматический запуск синхронизации в endpoint `toggle-price` при включении настройки
  - [x] Добавить автоматический запуск синхронизации в endpoint `update-multiplier` при изменении мультипликатора
  - [x] Обновить документацию (changelog.md, tasktracker.md)
- **Зависимости**: Существующая система синхронизации Allegro
- **Примечание**: Задачи запускаются асинхронно и не блокируют HTTP-ответ, ошибки логируются без прерывания основного запроса

## Задача: Исправление кругового импорта в модулях Celery
- **Статус**: Завершена
- **Описание**: Устранение циклической зависимости между app/celery_app.py, app/services/warehouse/manager.py и app/services/allegro/sync_tasks.py
- **Шаги выполнения**:
  - [x] Проанализировать причину кругового импорта
  - [x] Создать план решения с отдельным модулем для общих объектов
  - [x] Обновить документацию (changelog.md, tasktracker.md)
  - [x] Создать app/celery_shared.py с общими объектами
  - [x] Обновить app/celery_app.py - убрать общие объекты, оставить только задачи
  - [x] Обновить app/services/allegro/sync_tasks.py - изменить импорт на celery_shared
  - [x] Код готов к тестированию (пользователь тестирует самостоятельно)
  - [x] Обновить документацию по завершении
- **Зависимости**: нет
- **Примечание**: Решение - создание app/celery_shared.py с общими объектами (celery, SessionLocal, get_allegro_token), что разорвало циклическую зависимость

## Задача: Исправление совместной работы фильтров по остаткам
- **Статус**: Завершена
- **Описание**: Исправление проблемы, когда фильтры по минимальному и максимальному количеству не работали одновременно
- **Шаги выполнения**:
  - [x] Диагностировать проблему с отдельными вызовами .having()
  - [x] Объединить условия фильтрации в один вызов .having() с логическим AND
  - [x] Выявить дополнительную проблему в JavaScript коде
  - [x] Исправить логику передачи параметров на фронтенде
  - [x] Упростить проверки в бэкенде
  - [x] Выявить проблему с пользовательским интерфейсом и логикой ввода
  - [x] Добавить автоматическую коррекцию некорректных значений фильтров
  - [x] Улучшить пользовательский интерфейс фильтров
  - [x] Добавить визуальные подсказки и математические символы
  - [x] Протестировать работу фильтров вместе
  - [x] Обновить changelog
  - [x] Обновить tasktracker
- **Зависимости**: нет
- **Примечание**: Основная проблема была в том, что пользователи путали поля фильтров и вводили значения наоборот. Добавлена автоматическая коррекция и улучшен UI.

## Задача: Расширенные фильтры каталога товаров
- **Статус**: Завершена
- **Описание**: Добавление новых фильтров для каталога товаров: фильтр "больше чем" для остатков и фильтр по бренду через выпадающий список
- **Шаги выполнения**:
  - [x] Создать эндпоинт для получения списка уникальных брендов
  - [x] Добавить параметр brand_filter в эндпоинты каталога
  - [x] Добавить параметр min_stock_filter в UI
  - [x] Обновить фронтенд: добавить выпадающий список брендов
  - [x] Обновить JavaScript для обработки новых фильтров
  - [x] Обновить документацию
- **Зависимости**: нет

## Задача: Интеграция с удаленной БД цен товаров
- **Статус**: Завершена
- **Описание**: Создание отдельного интерфейса для подключения к удаленной БД цен с возможностью получения и редактирования цен как для отдельных товаров, так и для всего каталога. Интеграция в существующие шаблоны с возможностью редактирования администраторами.
- **Шаги выполнения**:
  - [x] Добавить конфигурацию для подключения к удаленной БД цен
  - [x] Создать отдельный сервис для работы с БД цен (app/services/prices_service.py)
  - [x] Создать модели для работы с таблицей prices_data
  - [x] Реализовать полный CRUD интерфейс для работы с ценами
  - [x] Создать API роуты для получения/обновления цен
  - [x] Обновить шаблон карточки товара для отображения цены
  - [x] Обновить страницу управления товаром для отображения и редактирования цен
  - [x] Добавить JavaScript для редактирования цен администраторами
  - [x] Добавить модальные окна для редактирования цен
  - [x] Интегрировать получение цен в каталог товаров
  - [x] Добавить обработку ошибок и fallback при недоступности БД цен
  - [x] Обновить документацию проекта
- **Зависимости**: нет
- **Примечание**: Реализован полный интерфейс для работы с удаленной БД цен с поддержкой валют, массовых операций и статистики. Интеграция выполнена без breaking changes в существующую архитектуру.

## Задача: Автоматическая синхронизация остатков товаров с офферами Allegro
- **Статус**: В процессе
- **Описание**: Реализация системы автоматической синхронизации остатков товаров из локальной базы данных с офферами на всех аккаунтах Allegro при изменении остатков на складе
- **Шаги выполнения**:
  - [x] Реализовать пайплайн Celery задач для массовой синхронизации
  - [x] Добавить rate limiter для соблюдения лимитов API Allegro
  - [x] Реализовать систему уведомлений об ошибках в Telegram
  - [x] Добавить детальное логирование и мониторинг
  - [x] Добавить булевый флаг is_sync_enabled в модель товара и миграцию
  - [x] Реализовать задачу sync_allegro_stock_single_product для синхронизации одного товара по всем аккаунтам (**завершено**)
  - [x] Добавить API endpoint и кнопку в UI для запуска синхронизации одного товара (**завершено**)
  - [x] Исправить ошибку инициализации InventoryManager в Celery задачах (**завершено**)
  - [x] Исправить ошибку 405 Method Not Allowed в API Allegro (**завершено**)
  - [x] Создать таблицу блокировок productsynclock (**завершено**)
  - [ ] Обновить бизнес-логику синхронизации: сначала is_sync_enabled, затем логику с локами (**в процессе**)
  - [ ] Реализовать и интегрировать механизм блокировок (локов) для защиты от дублирующихся обновлений по SKU (**в процессе**)
  - [x] Добавить кнопку в UI карточки товара для ручного включения/отключения синхронизации (**завершено**)
  - [ ] Интегрировать задачу в планировщик Celery Beat (**запланировано**)
- **Зависимости**: нет

## Задача: Переработка системы синхронизации товаров с Allegro
- **Статус**: Завершена
- **Описание**: Переработка системы управления синхронизацией товаров с Allegro. Вместо общего флага is_sync_enabled для товара, реализация индивидуальных настроек синхронизации для каждого токена Allegro отдельно.
- **Цель**: Обеспечить более гибкое управление синхронизацией товаров с разными аккаунтами Allegro с возможностью настройки синхронизации остатков, цен и ценовых мультипликаторов для каждого аккаунта отдельно.
- **Шаги выполнения**:
  - [x] 1. Создать модель ProductAllegroSyncSettings для хранения настроек синхронизации товара с каждым токеном
  - [x] 2. Создать миграцию для новой модели
  - [x] 3. Создать новый роутер для страницы управления товаром /products/{sku}/manage
  - [x] 4. Создать HTML шаблон для страницы управления товаром с настройками синхронизации
  - [x] 5. Создать API эндпоинты для управления настройками синхронизации по токенам
  - [x] 6. Обновить компонент product_card.html - заменить тогл на кнопку управления
  - [ ] 7. Обновить логику синхронизации для учета индивидуальных настроек по токенам
  - [x] 8. Создать сервис для работы с настройками синхронизации товаров
- **Зависимости**: Существующие модели Product, AllegroToken, система синхронизации
- **Технические детали**:
  - Новая модель содержит: product_sku, allegro_account_name, stock_sync_enabled, price_sync_enabled, price_multiplier
  - Страница управления товаром показывает все данные товара + список токенов с настройками
  - Сохранена обратная совместимость с существующей системой
  - Архитектура готова для перехода на микросервисную систему
- **Прогресс**: Базовая система завершена. Остается только обновить существующую логику синхронизации для использования новых настроек.
