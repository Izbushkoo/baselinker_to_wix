<!-- tg_product_card.html -->
<div class="tg-product-card" data-sku="{{ product.sku }}" data-warehouses='{{ product.stocks.keys()|list|tojson }}'>
  <div class="tg-product-main">
    <div class="tg-product-image">
      <img src="data:image/jpeg;base64,{{ product.image }}" alt="{{ product.name }}">
    </div>
    <div class="tg-product-info">
      <div class="tg-product-sku">
        <button class="tg-product-card-sku" data-sku="{{ product.sku }}" onclick="copyToClipboard(this);">
          {% if product.sku|length > 20 %}
            {{ product.sku[:10] }}...{{ product.sku[-10:] }}
          {% else %}
            {{ product.sku }}
          {% endif %}
        </button>
      </div>
      <div class="tg-product-title">
        {{ product.name }}
      </div>
      <div class="tg-product-stock">
        <div class="tg-product-status {% if product.total_stock > 5 %}in{% elif product.total_stock > 0 %}low{% else %}out{% endif %}">
          {% if product.total_stock > 5 %}В наличии{% elif product.total_stock > 0 %}Мало{% else %}Нет в наличии{% endif %}
        </div>
        {% set qty_class = 'green' if product.total_stock > 5 else 'yellow' if product.total_stock > 0 else 'red' %}
        <div class="tg-product-qty {{ qty_class }}">
          {{ product.total_stock }} шт.
        </div>
      </div>
      <div class="tg-product-toggle" onclick="toggleDetails(this.closest('.tg-product-card'))">
        <span class="toggle-text">Детали по складам ▼</span>
      </div>
    </div>
  </div>
  <div class="tg-product-details">
    {% for warehouse, qty in product.stocks.items() %}
    {% set qty_class = 'green' if qty > 5 else 'yellow' if qty > 0 else 'red' %}
    <div class="stock-item">
      <div class="stock-item-name">{{ warehouse }}</div>
      <div class="stock-item-qty {{ qty_class }}">{{ qty }} шт.</div>
    </div>
    {% endfor %}
    {% if current_user and current_user.is_admin %}
    <div class="stock-item-controls">
      <button class="stock-item-controls plus" onclick="showStockModal('add', '{{ product.sku }}')" title="Пополнить">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M12 4v16m8-8H4" />
        </svg>
      </button>
      <button class="stock-item-controls minus" onclick="showStockModal('remove', '{{ product.sku }}')" title="Списать">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M20 12H4" />
        </svg>
      </button>
      <button class="stock-item-controls transfer" onclick="showStockModal('move', '{{ product.sku }}')" title="Переместить">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M5 12h14m-4-4l4 4-4 4m-6-8l-4 4 4 4" />
        </svg>
      </button>
    </div>
    {% endif %}
  </div>
  {% if current_user and current_user.is_admin %}
  <button class="delete-button" onclick="deleteProduct('{{ product.sku }}', '{{ product.name }}')" title="Удалить товар">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
    </svg>
  </button>
  <!-- Модальное окно для операций со складом -->
  <div class="stock-modal" id="stockModal-{{ product.sku }}" style="display:none;">
    <div class="stock-modal-content">
      <div class="stock-modal-title" id="stockModalTitle-{{ product.sku }}"></div>
      <div class="stock-modal-fields" id="stockModalFields-{{ product.sku }}"></div>
      <div class="stock-modal-actions">
        <button onclick="closeStockModal('{{ product.sku }}')" class="stock-modal-btn cancel">Отмена</button>
        <button onclick="confirmStockModal('{{ product.sku }}')" class="stock-modal-btn ok">OK</button>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
  function copyToClipboard(element) {
      if (element.classList.contains('copying')) return;
      const text = element.getAttribute('data-sku');
      navigator.clipboard.writeText(text).then(() => {
          const originalText = element.textContent;
          element.textContent = 'Скопировано!';
          element.style.backgroundColor = 'rgba(34, 197, 94, 0.7)';
          element.style.color = 'white';
          element.style.pointerEvents = 'none';
          element.classList.add('copying');
          setTimeout(() => {
              element.textContent = originalText;
              element.style.backgroundColor = '';
              element.style.color = '';
              element.style.pointerEvents = '';
              element.classList.remove('copying');
          }, 1000);
      });
  }
  
  function toggleDetails(card) {
      card.classList.toggle('expanded');
      const toggleText = card.querySelector('.toggle-text');
      if (card.classList.contains('expanded')) {
          toggleText.textContent = 'Детали по складам ▲';
      } else {
          toggleText.textContent = 'Детали по складам ▼';
      }
  }
  
  function findStockItemByWarehouse(card, warehouse) {
      const items = card.querySelectorAll('.stock-item');
      for (const item of items) {
          const nameDiv = item.querySelector('.stock-item-name');
          if (nameDiv && nameDiv.textContent.trim() === warehouse) {
              return item;
          }
      }
      return null;
  }

  async function updateStockDisplay(card, warehouse, delta) {
      if (!card) return;
      
      // Найти нужный stock-item по названию склада
      const stockItem = findStockItemByWarehouse(card, warehouse);
      if (stockItem) {
          const qtyElement = stockItem.querySelector('.stock-item-qty');
          const currentQty = parseInt(qtyElement.textContent);
          const newQty = currentQty + delta;
          
          qtyElement.textContent = `${newQty} шт.`;
          qtyElement.className = 'stock-item-qty ' + 
              (newQty > 5 ? 'green' : newQty > 0 ? 'yellow' : 'red');
      }
      
      // Обновляем общее количество
      const totalQtyElement = card.querySelector('.tg-product-qty');
      const currentTotal = parseInt(totalQtyElement.textContent);
      const newTotal = currentTotal + delta;
      
      totalQtyElement.textContent = `${newTotal} шт.`;
      totalQtyElement.className = 'tg-product-qty ' + 
          (newTotal > 5 ? 'green' : newTotal > 0 ? 'yellow' : 'red');
      
      // Обновляем статус наличия
      const statusElement = card.querySelector('.tg-product-status');
      if (newTotal > 5) {
          statusElement.textContent = 'В наличии';
          statusElement.className = 'tg-product-status in';
      } else if (newTotal > 0) {
          statusElement.textContent = 'Мало';
          statusElement.className = 'tg-product-status low';
      } else {
          statusElement.textContent = 'Нет в наличии';
          statusElement.className = 'tg-product-status out';
      }
  }
  
  async function addToStock(sku, warehouse, quantity) {
      try {
          const response = await fetch('/api/warehouse/add/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  sku,
                  warehouse,
                  quantity
              })
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Ошибка при пополнении остатков');
          }

          const data = await response.json();
          
          // Обновляем отображение
          const card = document.querySelector(`.tg-product-card[data-sku="${sku}"]`);
          await updateStockDisplay(card, warehouse, quantity);

          tg.showAlert(data.message || 'Остатки успешно пополнены');
          return true;

      } catch (error) {
          console.error('Error:', error);
          tg.showAlert(error.message || 'Произошла ошибка при пополнении остатков');
          return false;
      }
  }

  async function removeFromStock(sku, warehouse, quantity) {
      try {
          const response = await fetch('/api/warehouse/remove/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  sku,
                  warehouse,
                  quantity
              })
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Ошибка при списании остатков');
          }

          const data = await response.json();
          
          // Обновляем отображение
          const card = document.querySelector(`.tg-product-card[data-sku="${sku}"]`);
          await updateStockDisplay(card, warehouse, -quantity);

          tg.showAlert(data.message || 'Остатки успешно списаны');
          return true;

      } catch (error) {
          console.error('Error:', error);
          tg.showAlert(error.message || 'Произошла ошибка при списании остатков');
          return false;
      }
  }

  async function updateStock(sku, warehouse, delta) {
      const quantity = Math.abs(delta);
      if (delta > 0) {
          return await addToStock(sku, warehouse, quantity);
      } else {
          return await removeFromStock(sku, warehouse, quantity);
      }
  }
  
  async function moveStock(sku, fromWarehouse) {
      try {
          const result = await new Promise(resolve => {
              const warehouses = ['WH1', 'WH2', 'WH3', 'WH4'];
              const buttons = warehouses
                  .filter(wh => wh !== fromWarehouse)
                  .map(wh => ({
                      id: wh,
                      text: `Склад ${wh}`
                  }));
              
              tg.showPopup({
                  title: 'Перемещение товара',
                  message: 'Выберите склад назначения:',
                  buttons: buttons
              }, resolve);
          });
          
          if (!result) return;
          
          const toWarehouse = result;
          
          const qty = await new Promise(resolve => {
              tg.showPopup({
                  title: 'Количество',
                  message: 'Введите количество для перемещения:',
                  buttons: [
                      { type: 'default', id: 'cancel', text: 'Отмена' }
                  ]
              }, resolve);
          });
          
          if (!qty || isNaN(qty) || qty <= 0) {
              tg.showAlert('Неверное количество');
              return;
          }
          
          // Сначала списываем со склада-источника
          const removed = await removeFromStock(sku, fromWarehouse, qty);
          if (!removed) return;
          
          // Затем добавляем на склад-получатель
          const added = await addToStock(sku, toWarehouse, qty);
          if (!added) {
              // Если не удалось добавить, возвращаем обратно на исходный склад
              await addToStock(sku, fromWarehouse, qty);
              return;
          }
          
          tg.showAlert(`Успешно перемещено ${qty} шт. со склада ${fromWarehouse} на склад ${toWarehouse}`);
          
      } catch (error) {
          console.error('Error:', error);
          tg.showAlert('Произошла ошибка при перемещении товара');
      }
  }

  async function deleteProduct(sku, name) {
      const confirmed = await new Promise(resolve => {
          tg.showConfirm(`Вы уверены, что хотите удалить товар "${name}"?`, resolve);
      });

      if (!confirmed) return;

      try {
          const response = await fetch(`/api/products/${sku}`, {
              method: 'DELETE'
          });

          if (!response.ok) {
              const errorData = await response.json();
              tg.showAlert(errorData.detail || 'Ошибка при удалении товара');
              return;
          }

          // Находим и удаляем карточку из DOM
          const card = document.querySelector(`.tg-product-card[data-sku="${sku}"]`);
          if (card) {
              card.remove();
          }

          tg.showAlert('Товар успешно удален');

      } catch (error) {
          console.error('Error:', error);
          tg.showAlert('Произошла ошибка при удалении товара');
      }
  }

  function showStockModal(action, sku) {
      const modal = document.getElementById(`stockModal-${sku}`);
      const title = document.getElementById(`stockModalTitle-${sku}`);
      const fields = document.getElementById(`stockModalFields-${sku}`);
      const card = document.querySelector(`.tg-product-card[data-sku="${sku}"]`);
      const warehouses = JSON.parse(card.dataset.warehouses);
      let html = '';
      if (action === 'move') {
          title.textContent = 'Перемещение товара';
          html = `
              <label>Склад-источник:<br>
                  <select id="modalFrom-${sku}">${warehouses.map(w => `<option value="${w}">${w}</option>`).join('')}</select>
              </label><br><br>
              <label>Склад-назначения:<br>
                  <select id="modalTo-${sku}">${warehouses.map(w => `<option value="${w}">${w}</option>`).join('')}</select>
              </label><br><br>
              <label>Количество:<br>
                  <input id="modalQty-${sku}" type="number" min="1" style="width:80px;">
              </label>
          `;
      } else {
          title.textContent = action === 'add' ? 'Пополнение товара' : 'Списание товара';
          html = `
              <label>Склад:<br>
                  <select id="modalWarehouse-${sku}">${warehouses.map(w => `<option value="${w}">${w}</option>`).join('')}</select>
              </label><br><br>
              <label>Количество:<br>
                  <input id="modalQty-${sku}" type="number" min="1" style="width:80px;">
              </label>
          `;
      }
      fields.innerHTML = html;
      modal.style.display = 'flex';
      modal.dataset.action = action;
  }

  function closeStockModal(sku) {
      document.getElementById(`stockModal-${sku}`).style.display = 'none';
  }

  async function confirmStockModal(sku) {
      const modal = document.getElementById(`stockModal-${sku}`);
      const action = modal.dataset.action;
      const card = document.querySelector(`.tg-product-card[data-sku="${sku}"]`);
      const warehouses = JSON.parse(card.dataset.warehouses);
      if (action === 'move') {
          const from = document.getElementById(`modalFrom-${sku}`).value;
          const to = document.getElementById(`modalTo-${sku}`).value;
          const qty = parseInt(document.getElementById(`modalQty-${sku}`).value);
          if (!from || !to || from === to || !qty || qty <= 0) {
              tg.showAlert('Проверьте корректность выбора складов и количества');
              return;
          }
          // Вызов API для перемещения
          try {
              const response = await fetch('/api/warehouse/transfer-item/', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      sku: sku,
                      from_warehouse: from,
                      to_warehouse: to,
                      quantity: qty
                  })
              });
              const data = await response.json();
              if (!response.ok) throw new Error(data.detail || 'Ошибка при перемещении');
              tg.showAlert(data.message || 'Перемещение выполнено');
              // Можно обновить UI вручную, если нужно
          } catch (e) {
              tg.showAlert(e.message || 'Ошибка при перемещении');
          }
      } else {
          const warehouse = document.getElementById(`modalWarehouse-${sku}`).value;
          const qty = parseInt(document.getElementById(`modalQty-${sku}`).value);
          if (!warehouse || !qty || qty <= 0) {
              tg.showAlert('Проверьте корректность выбора склада и количества');
              return;
          }
          // Вызов API для пополнения/списания
          try {
              const url = action === 'add' ? '/api/warehouse/add/' : '/api/warehouse/remove/';
              const response = await fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      sku: sku,
                      warehouse: warehouse,
                      quantity: qty
                  })
              });
              const data = await response.json();
              if (!response.ok) throw new Error(data.detail || 'Ошибка при операции');
              tg.showAlert(data.message || 'Операция выполнена');
              // Можно обновить UI вручную, если нужно
          } catch (e) {
              tg.showAlert(e.message || 'Ошибка при операции');
          }
      }
      closeStockModal(sku);
  }
</script>