{% extends "base.html" %}

{% block title %}–î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ {{ operation.id|string|truncate(8) }}... | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫–ª–∞–¥–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .tooltip-text {
        position: absolute;
        z-index: 10;
        background-color: #1f2937;
        color: white;
        padding: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .group:hover .tooltip-text {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl text-white p-8 mb-8">
        <a href="/stock-sync/monitor" class="inline-block text-white hover:text-blue-200 mb-4 transition-colors duration-200">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π
        </a>
        <h1 class="text-4xl font-bold mb-3">üîç –î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ </h1>
        <div class="bg-white bg-opacity-20 text-sm font-mono px-3 py-2 rounded-lg inline-block">
            ID –∑–∞–∫–∞–∑–∞: <button onclick="copyToClipboard('{{ operation.order_id }}', this)" class="font-mono text-blue-400 hover:text-blue-600 focus:outline-none bg-transparent relative group">
                {{ operation.order_id }}
                <span class="tooltip-text hidden group-hover:block absolute left-1/2 -translate-x-1/2 top-full mt-1 px-2 py-1 rounded bg-gray-800 text-xs text-white z-10 whitespace-nowrap">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID –∑–∞–∫–∞–∑–∞</span>
            </button>
        </div>
        <div class="bg-white bg-opacity-20 text-sm font-mono px-3 py-2 rounded-lg inline-block">
            ID –æ–ø–µ—Ä–∞—Ü–∏–∏: {{ operation.id }}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="flex gap-4 mb-8">
        <button onclick="location.reload()" 
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        </button>
        
        {% if operation.order_id and operation.token_id and operation.account_name %}
        <a href="/allegro/orders/{{ operation.token_id }}/{{ operation.account_name }}?search={{ operation.order_id }}" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
            üìã –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑—É
        </a>
        {% elif operation.order_id %}
        <a href="/synchronization" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
            üìã –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑–∞–º
        </a>
        {% endif %}
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-3">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">ID –ó–∞–∫–∞–∑–∞:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.order_id }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.operation_type }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°–∫–ª–∞–¥:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.warehouse }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°—Ç–∞—Ç—É—Å:</span>
                    {% if operation.status == 'failed' %}
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–ü–†–û–í–ê–õ–ï–ù–û</span>
                    {% elif operation.status == 'pending' %}
                        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–í –û–ñ–ò–î–ê–ù–ò–ò</span>
                    {% elif operation.status == 'processing' %}
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–í –û–ë–†–ê–ë–û–¢–ö–ï</span>
                    {% elif operation.status == 'completed' %}
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–ó–ê–í–ï–†–®–ï–ù–û</span>
                    {% else %}
                        <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-bold uppercase">{{ operation.status }}</span>
                    {% endif %}
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ê–∫–∫–∞—É–Ω—Ç:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.account_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-3">‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°–æ–∑–¥–∞–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.created_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% if operation.updated_at %}
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.updated_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% endif %}
                {% if operation.completed_at %}
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.completed_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% endif %}
                {% if operation.next_retry_at %}
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.next_retry_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-3">üîÑ –ü–æ–ø—ã—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ü–æ–ø—ã—Ç–æ–∫ —Å–¥–µ–ª–∞–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.retry_count }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.max_retries }}</span>
                </div>
                {% if operation.error_message %}
                <div class="flex flex-col space-y-2">
                    <span class="font-semibold text-gray-600">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞:</span>
                    <div class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded text-sm">
                        {{ operation.error_message }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
    {% if validation_details %}
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center mb-6">
            <h3 class="text-xl font-bold text-red-600 mr-4">‚ö†Ô∏è –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–∞–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏</h3>
        </div>
        
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
            <strong>–°–≤–æ–¥–∫–∞:</strong> 
            {{ validation_details.invalid_items }} –∏–∑ {{ validation_details.total_items }} –ø–æ–∑–∏—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
        </div>

        {% if validation_details.items_details %}
        <div class="grid gap-4">
            {% for item in validation_details.items_details %}
            <div class="border rounded-lg p-4 {% if item.valid %}border-l-4 border-l-green-400 bg-green-50{% else %}border-l-4 border-l-red-400 bg-red-50{% endif %}">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <span class="font-mono font-bold text-gray-800 select-all">{{ item.sku }}</span>
                        <button onclick="copyToClipboard('{{ item.sku }}')" 
                                class="text-blue-600 hover:text-blue-800 p-1 rounded transition-colors duration-200" 
                                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SKU">
                            üìã
                        </button>
                    </div>
                    {% if item.valid %}
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">–î–û–°–¢–£–ü–ù–û</span>
                    {% else %}
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">–ù–ï–î–û–°–¢–£–ü–ù–û</span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">{{ item.required_quantity }}</div>
                        <div class="text-sm text-gray-600">–¢—Ä–µ–±—É–µ—Ç—Å—è</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-2xl font-bold text-green-600">{{ item.available_quantity }}</div>
                        <div class="text-sm text-gray-600">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                    </div>
                    {% if item.shortage_quantity > 0 %}
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-2xl font-bold text-red-600">{{ item.shortage_quantity }}</div>
                        <div class="text-sm text-gray-600">–ù–µ–¥–æ—Å—Ç–∞–µ—Ç</div>
                    </div>
                    {% endif %}
                </div>
                
                {% if item.error_message %}
                <div class="text-red-600 text-sm mt-3">
                    <strong>–û—à–∏–±–∫–∞:</strong> {{ item.error_message }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- –¢–æ–≤–∞—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">üì¶ –¢–æ–≤–∞—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
            <div class="flex items-center gap-3">
                {% if operation.order_id and operation.token_id and operation.account_name %}
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∞–Ω–∏–µ–º -->
                <div class="flex items-center gap-2">
                    <!-- –°—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∞–Ω–∏—è -->
                    <div id="stock-status-{{ operation.order_id }}" class="px-3 py-1 rounded-full text-sm font-medium">
                        {% if operation.line_items and operation.line_items|length > 0 %}
                            {% set first_item = operation.line_items[0] %}
                            {% if first_item.offer and first_item.offer.external and first_item.offer.external.id %}
                                <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium" id="status-indicator">
                                    –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ "–°–ø–∏—Å–∞—Ç—å" -->
                    <button onclick="saleFromOrder('{{ operation.order_id }}', '{{ operation.token_id }}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors duration-200 flex items-center gap-1"
                            id="write-off-btn-{{ operation.order_id }}"
                            data-warehouse="{{ operation.warehouse or '–ò—Ä–∏–Ω–∞' }}"
                            data-line-items='{{ operation.line_items | tojson if operation.line_items else "[]" | safe }}'>
                        üìù –°–ø–∏—Å–∞—Ç—å
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–º–µ—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã–º" -->
                    <button onclick="markOrderStockUpdated('{{ operation.order_id }}', '{{ operation.token_id }}')" 
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors duration-200 flex items-center gap-1"
                            id="mark-written-off-btn-{{ operation.order_id }}">
                        ‚úÖ –ü–æ–º–µ—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã–º
                    </button>
                </div>
                {% endif %}
                
                {% if operation.line_items and operation.line_items|length > 0 %}
                <a href="/catalog?operation_skus={% for item in operation.line_items %}{{ item.offer.external.id }}{% if not loop.last %},{% endif %}{% endfor %}" 
                   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
                    üõçÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º
                </a>
                {% endif %}
            </div>
        </div>

        {% if operation.line_items and operation.line_items|length > 0 %}
        <div class="grid gap-4">
            {% for item in operation.line_items %}
            <div class="border rounded-lg p-4 bg-gray-50">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-mono font-bold text-gray-800">{{ item.offer.external.id }}</span>
                            <button onclick="copyToClipboard('{{ item.offer.external.id }}')" 
                                    class="text-blue-600 hover:text-blue-800 p-1 rounded transition-colors duration-200" 
                                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SKU">
                                üìã
                            </button>
                        </div>
                        
                        {% if item.offer.name %}
                        <div class="text-gray-700 mb-2">
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ item.offer.name }}
                        </div>
                        {% endif %}
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div class="text-center p-3 bg-white rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">{{ item.quantity }}</div>
                                <div class="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                            </div>
                            {% if item.price and item.price.amount %}
                            <div class="text-center p-3 bg-white rounded-lg">
                                <div class="text-2xl font-bold text-green-600">{{ "%.2f"|format(item.price.amount|float) }}</div>
                                <div class="text-sm text-gray-600">{{ item.price.currency or 'PLN' }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 ml-4">
                        {% if item.product_exists %}
                        <a href="/catalog?search={{ item.offer.external.id }}" 
                           class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors duration-200 flex items-center gap-1">
                            ‚û°Ô∏è –ö —Ç–æ–≤–∞—Ä—É
                        </a>
                        {% else %}
                        <a href="/products/add?sku={{ item.offer.external.id }}&name={{ item.offer.name|urlencode }}&quantity={{ item.quantity }}" 
                           class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors duration-200 flex items-center gap-1">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üì¶</div>
            <div class="text-lg">–¢–æ–≤–∞—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>
        {% endif %}
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫ -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">üìù –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫</h3>
            <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">{{ logs_count }} –∑–∞–ø–∏—Å–µ–π</span>
        </div>

        {% if logs %}
        <div class="space-y-4">
            {% for log in logs %}
            <div class="border rounded-lg p-4 {% if log.status == 'error' %}bg-red-50 border-red-200{% elif log.status == 'warning' %}bg-yellow-50 border-yellow-200{% else %}bg-blue-50 border-blue-200{% endif %}">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-gray-800">{{ log.action|localize_action }}</span>
                    <span class="text-sm text-gray-600">{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                
                <div class="text-gray-700 mb-3">
                    {% if log.details and log.details.message %}
                        {{ localize_log_message(log.action, log.details.message, log.details) }}
                    {% else %}
                        –ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è
                    {% endif %}
                </div>
                
                {% if log.execution_time_ms %}
                <div class="text-sm text-gray-600 mb-3">
                    ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {{ log.execution_time_ms }}–º—Å
                </div>
                {% endif %}
                
                {% if log.details and log.details|length > 1 %}
                <details class="mt-3">
                    <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">
                        üìã –ü–æ–¥—Ä–æ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </summary>
                    <div class="mt-3 bg-gray-50 border rounded-lg p-4 max-h-96 overflow-y-auto">
                        {{ format_log_details(log.details) | safe }}
                    </div>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üìù</div>
            <div class="text-lg">–õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è JavaScript -->
<div id="operation-data" 
     data-order-id="{{ operation.order_id or '' }}"
     data-token-id="{{ operation.token_id or '' }}"
     data-account-name="{{ operation.account_name or '' }}"
     data-warehouse="{{ operation.warehouse or '–ò—Ä–∏–Ω–∞' }}"
     data-status="{{ operation.status }}"
     data-has-order-data="{{ 'true' if operation.order_id and operation.token_id and operation.account_name else 'false' }}"
     style="display: none;">
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
    const operationData = document.getElementById('operation-data');
    const operationOrderId = operationData.dataset.orderId;
    const operationTokenId = operationData.dataset.tokenId;
    const operationAccountName = operationData.dataset.accountName;
    const operationWarehouse = operationData.dataset.warehouse;
    const operationStatus = operationData.dataset.status;
    const operationHasOrderData = operationData.dataset.hasOrderData === 'true';

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    if (operationStatus === 'pending' || operationStatus === 'processing') {
        setInterval(() => {
            location.reload();
        }, 60000);
    }

    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    function copyToClipboard(text, button) {
        if (navigator.clipboard && window.isSecureContext) {
            // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(button);
            }).catch(() => {
                fallbackCopy(text, button);
            });
        } else {
            // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            fallbackCopy(text, button);
        }
    }

    function fallbackCopy(text, button) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopySuccess(button);
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
        
        document.body.removeChild(textArea);
    }

    function showCopySuccess(button) {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
        const notification = document.createElement('div');
        notification.textContent = 'ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 2000);
    }

    // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.bg-white');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
        if (operationHasOrderData) {
            // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ - –æ–Ω —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∞–Ω–∏—è –æ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞');
            loadStockStatus(operationOrderId, operationTokenId);
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏—Å–∞–Ω–∏—è
    async function loadStockStatus(orderId, tokenId) {
        try {
            console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId} –∏ —Ç–æ–∫–µ–Ω–∞ ${tokenId}`);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const response = await fetch(`/api/allegro_sync/orders/${tokenId}`);
            if (response.ok) {
                const data = await response.json();
                console.log('–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞:', data);
                console.log('–¢–∏–ø –æ—Ç–≤–µ—Ç–∞:', typeof data);
                console.log('–ö–ª—é—á–∏ –æ—Ç–≤–µ—Ç–∞:', Object.keys(data));
                
                // –ò—â–µ–º –Ω—É–∂–Ω—ã–π –∑–∞–∫–∞–∑ –≤ —Å–ø–∏—Å–∫–µ
                const order = data.orders ? data.orders.find(o => o.id === orderId) : null;
                if (order) {
                    console.log('–ù–∞–π–¥–µ–Ω –∑–∞–∫–∞–∑:', order);
                    console.log('–§–ª–∞–≥ is_stock_updated:', order.is_stock_updated);
                    console.log('–¢–∏–ø —Ñ–ª–∞–≥–∞ is_stock_updated:', typeof order.is_stock_updated);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–ª–∞–≥ is_stock_updated
                    if (order.hasOwnProperty('is_stock_updated')) {
                        updateStockStatus(orderId, order.is_stock_updated);
                    } else {
                        console.warn('–§–ª–∞–≥ is_stock_updated –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞');
                        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ñ–ª–∞–≥ –≤ –¥—Ä—É–≥–∏—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
                        if (order.stock_updated !== undefined) {
                            console.log('–ù–∞–π–¥–µ–Ω —Ñ–ª–∞–≥ stock_updated:', order.stock_updated);
                            updateStockStatus(orderId, order.stock_updated);
                        } else {
                            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ–ª–∞–≥ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏—Å–∞–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ');
                            updateStockStatus(orderId, false);
                        }
                    }
                } else {
                    console.error(`–ó–∞–∫–∞–∑ ${orderId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –∑–∞–∫–∞–∑–æ–≤`);
                    updateStockStatus(orderId, false);
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', response.status, response.statusText);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ù–µ —Å–ø–∏—Å–∞–Ω–æ" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                updateStockStatus(orderId, false);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏—Å–∞–Ω–∏—è:', error);
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ù–µ —Å–ø–∏—Å–∞–Ω–æ" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            updateStockStatus(orderId, false);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏—Å–∞–Ω–∏—è
    function updateStockStatus(orderId, isStockUpdated) {
        console.log(`–û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId}: isStockUpdated = ${isStockUpdated} (—Ç–∏–ø: ${typeof isStockUpdated})`);
        
        const statusIndicator = document.getElementById('status-indicator');
        const writeOffBtn = document.getElementById(`write-off-btn-${orderId}`);
        const markWrittenOffBtn = document.getElementById(`mark-written-off-btn-${orderId}`);
        
        console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:', {
            statusIndicator: !!statusIndicator,
            writeOffBtn: !!writeOffBtn,
            markWrittenOffBtn: !!markWrittenOffBtn
        });
        
        if (statusIndicator) {
            if (isStockUpdated === true || isStockUpdated === 'true') {
                console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–°–ø–∏—Å–∞–Ω–æ"');
                statusIndicator.className = 'bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
                statusIndicator.textContent = '–°–ø–∏—Å–∞–Ω–æ';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è –µ—Å–ª–∏ —É–∂–µ —Å–ø–∏—Å–∞–Ω–æ
                if (writeOffBtn) {
                    writeOffBtn.style.display = 'none';
                    console.log('–ö–Ω–æ–ø–∫–∞ "–°–ø–∏—Å–∞—Ç—å" —Å–∫—Ä—ã—Ç–∞');
                }
                if (markWrittenOffBtn) {
                    markWrittenOffBtn.style.display = 'none';
                    console.log('–ö–Ω–æ–ø–∫–∞ "–ü–æ–º–µ—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã–º" —Å–∫—Ä—ã—Ç–∞');
                }
            } else {
                console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ù–µ —Å–ø–∏—Å–∞–Ω–æ"');
                statusIndicator.className = 'bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium';
                statusIndicator.textContent = '–ù–µ —Å–ø–∏—Å–∞–Ω–æ';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è –µ—Å–ª–∏ –Ω–µ —Å–ø–∏—Å–∞–Ω–æ
                if (writeOffBtn) {
                    writeOffBtn.style.display = 'inline-flex';
                    console.log('–ö–Ω–æ–ø–∫–∞ "–°–ø–∏—Å–∞—Ç—å" –ø–æ–∫–∞–∑–∞–Ω–∞');
                }
                if (markWrittenOffBtn) {
                    markWrittenOffBtn.style.display = 'inline-flex';
                    console.log('–ö–Ω–æ–ø–∫–∞ "–ü–æ–º–µ—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã–º" –ø–æ–∫–∞–∑–∞–Ω–∞');
                }
            }
        } else {
            console.error('–≠–ª–µ–º–µ–Ω—Ç status-indicator –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∑–∞–∫–∞–∑–∞
    async function saleFromOrder(orderId, tokenId) {
        try {
            console.log(`–ù–∞—á–∏–Ω–∞–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId} –∏ —Ç–æ–∫–µ–Ω–∞ ${tokenId}`);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∫–Ω–æ–ø–∫–∏
            const writeOffBtn = document.getElementById(`write-off-btn-${orderId}`);
            const lineItems = JSON.parse(writeOffBtn.dataset.lineItems);
            const warehouse = writeOffBtn.dataset.warehouse;
            
            console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:', {
                orderId,
                tokenId,
                lineItems,
                warehouse
            });
            
            if (!lineItems || lineItems.length === 0) {
                showNotification('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è', 'error');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ
            const response = await fetch('/api/warehouse/sale-from-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    token_id: tokenId,
                    line_items: lineItems,
                    warehouse: warehouse
                })
            });

            const data = await response.json();
            console.log('–û—Ç–≤–µ—Ç –æ—Ç API —Å–ø–∏—Å–∞–Ω–∏—è:', data);
            
            if (response.ok) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                updateStockStatus(orderId, true);
                showNotification(data.message || '–¢–æ–≤–∞—Ä—ã —É—Å–ø–µ—à–Ω–æ —Å–ø–∏—Å–∞–Ω—ã', 'success');
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + error.message, 'error');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–º–µ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ —Å–ø–∏—Å–∞–Ω–Ω–æ–≥–æ
    async function markOrderStockUpdated(orderId, tokenId) {
        try {
            console.log(`–ü–æ–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑ ${orderId} –∫–∞–∫ —Å–ø–∏—Å–∞–Ω–Ω—ã–π –¥–ª—è —Ç–æ–∫–µ–Ω–∞ ${tokenId}`);
            
            const response = await fetch(`/api/allegro_sync/orders/${tokenId}/${orderId}/mark_stock_updated`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
            });
            
            console.log('–û—Ç–≤–µ—Ç –æ—Ç API –ø–æ–º–µ—Ç–∫–∏:', response.status, response.statusText);
            
            if (response.ok) {
                const data = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API –ø–æ–º–µ—Ç–∫–∏:', data);
                console.log('–§–ª–∞–≥ is_stock_updated –≤ –æ—Ç–≤–µ—Ç–µ:', data.is_stock_updated);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                updateStockStatus(orderId, data.is_stock_updated);
                showNotification('–ó–∞–∫–∞–∑ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —Å–ø–∏—Å–∞–Ω–Ω—ã–π', 'success');
            } else {
                const errorData = await response.json();
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –∑–∞–∫–∞–∑–∞:', errorData);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –∑–∞–∫–∞–∑–∞', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –∑–∞–∫–∞–∑–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –∑–∞–∫–∞–∑–∞: ' + error.message, 'error');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.textContent = message;
        
        let bgColor = 'bg-blue-600';
        if (type === 'success') bgColor = 'bg-green-600';
        if (type === 'error') bgColor = 'bg-red-600';
        if (type === 'warning') bgColor = 'bg-yellow-600';
        
        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}