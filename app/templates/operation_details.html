{% extends "base.html" %}

{% block title %}–î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ {{ operation.id|string|truncate(8) }}... | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫–ª–∞–¥–æ–≤{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl text-white p-8 mb-8">
        <a href="/stock-sync/monitor" class="inline-block text-white hover:text-blue-200 mb-4 transition-colors duration-200">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π
        </a>
        <h1 class="text-4xl font-bold mb-3">üîç –î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏</h1>
        <div class="bg-white bg-opacity-20 text-sm font-mono px-3 py-2 rounded-lg inline-block">
            ID: {{ operation.id }}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <button onclick="location.reload()" 
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 mb-8 flex items-center gap-2">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    </button>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-3">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">ID –ó–∞–∫–∞–∑–∞:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.order_id }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.operation_type }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°–∫–ª–∞–¥:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.warehouse }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°—Ç–∞—Ç—É—Å:</span>
                    {% if operation.status == 'failed' %}
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–ü–†–û–í–ê–õ–ï–ù–û</span>
                    {% elif operation.status == 'pending' %}
                        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–í –û–ñ–ò–î–ê–ù–ò–ò</span>
                    {% elif operation.status == 'processing' %}
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–í –û–ë–†–ê–ë–û–¢–ö–ï</span>
                    {% elif operation.status == 'completed' %}
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold uppercase">–ó–ê–í–ï–†–®–ï–ù–û</span>
                    {% else %}
                        <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-bold uppercase">{{ operation.status }}</span>
                    {% endif %}
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">Token ID:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.token_id|string|truncate(16) }}...</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-3">‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°–æ–∑–¥–∞–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.created_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% if operation.updated_at %}
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.updated_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% endif %}
                {% if operation.completed_at %}
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.completed_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% endif %}
                {% if operation.next_retry_at %}
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.next_retry_at.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-3">üîÑ –ü–æ–ø—ã—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ü–æ–ø—ã—Ç–æ–∫ —Å–¥–µ–ª–∞–Ω–æ:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.retry_count }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-600">–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫:</span>
                    <span class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ operation.max_retries }}</span>
                </div>
                {% if operation.error_message %}
                <div class="flex flex-col space-y-2">
                    <span class="font-semibold text-gray-600">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞:</span>
                    <div class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded text-sm">
                        {{ operation.error_message }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
    {% if validation_details %}
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center mb-6">
            <h3 class="text-xl font-bold text-red-600 mr-4">‚ö†Ô∏è –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–∞–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏</h3>
        </div>
        
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
            <strong>–°–≤–æ–¥–∫–∞:</strong> 
            {{ validation_details.invalid_items }} –∏–∑ {{ validation_details.total_items }} –ø–æ–∑–∏—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
        </div>

        {% if validation_details.items_details %}
        <div class="grid gap-4">
            {% for item in validation_details.items_details %}
            <div class="border rounded-lg p-4 {% if item.valid %}border-l-4 border-l-green-400 bg-green-50{% else %}border-l-4 border-l-red-400 bg-red-50{% endif %}">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <span class="font-mono font-bold text-gray-800 select-all">{{ item.sku }}</span>
                        <button onclick="copyToClipboard('{{ item.sku }}')" 
                                class="text-blue-600 hover:text-blue-800 p-1 rounded transition-colors duration-200" 
                                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SKU">
                            üìã
                        </button>
                    </div>
                    {% if item.valid %}
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">–î–û–°–¢–£–ü–ù–û</span>
                    {% else %}
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">–ù–ï–î–û–°–¢–£–ü–ù–û</span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">{{ item.required_quantity }}</div>
                        <div class="text-sm text-gray-600">–¢—Ä–µ–±—É–µ—Ç—Å—è</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-2xl font-bold text-green-600">{{ item.available_quantity }}</div>
                        <div class="text-sm text-gray-600">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                    </div>
                    {% if item.shortage_quantity > 0 %}
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-2xl font-bold text-red-600">{{ item.shortage_quantity }}</div>
                        <div class="text-sm text-gray-600">–ù–µ–¥–æ—Å—Ç–∞–µ—Ç</div>
                    </div>
                    {% endif %}
                </div>
                
                {% if item.error_message %}
                <div class="text-red-600 text-sm mt-3">
                    <strong>–û—à–∏–±–∫–∞:</strong> {{ item.error_message }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- –¢–æ–≤–∞—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">üì¶ –¢–æ–≤–∞—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
            {% if operation.line_items and operation.line_items|length > 0 %}
            <a href="/catalog?operation_skus={% for item in operation.line_items %}{{ item.offer.external.id }}{% if not loop.last %},{% endif %}{% endfor %}" 
               class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2">
                üõçÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º
            </a>
            {% endif %}
        </div>

        {% if operation.line_items and operation.line_items|length > 0 %}
        <div class="grid gap-4">
            {% for item in operation.line_items %}
            <div class="border rounded-lg p-4 bg-gray-50">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-mono font-bold text-gray-800">{{ item.offer.external.id }}</span>
                            <button onclick="copyToClipboard('{{ item.offer.external.id }}')" 
                                    class="text-blue-600 hover:text-blue-800 p-1 rounded transition-colors duration-200" 
                                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SKU">
                                üìã
                            </button>
                        </div>
                        
                        {% if item.offer.name %}
                        <div class="text-gray-700 mb-2">
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ item.offer.name }}
                        </div>
                        {% endif %}
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div class="text-center p-3 bg-white rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">{{ item.quantity }}</div>
                                <div class="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                            </div>
                            {% if item.price and item.price.amount %}
                            <div class="text-center p-3 bg-white rounded-lg">
                                <div class="text-2xl font-bold text-green-600">{{ "%.2f"|format(item.price.amount|float) }}</div>
                                <div class="text-sm text-gray-600">{{ item.price.currency or 'PLN' }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 ml-4">
                        {% if item.product_exists %}
                        <a href="/catalog?search={{ item.offer.external.id }}" 
                           class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors duration-200 flex items-center gap-1">
                            ‚û°Ô∏è –ö —Ç–æ–≤–∞—Ä—É
                        </a>
                        {% else %}
                        <a href="/products/add?sku={{ item.offer.external.id }}&name={{ item.offer.name|urlencode }}&quantity={{ item.quantity }}" 
                           class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors duration-200 flex items-center gap-1">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üì¶</div>
            <div class="text-lg">–¢–æ–≤–∞—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>
        {% endif %}
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫ -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">üìù –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫</h3>
            <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">{{ logs_count }} –∑–∞–ø–∏—Å–µ–π</span>
        </div>

        {% if logs %}
        <div class="space-y-4">
            {% for log in logs %}
            <div class="border rounded-lg p-4 {% if log.status == 'error' %}bg-red-50 border-red-200{% elif log.status == 'warning' %}bg-yellow-50 border-yellow-200{% else %}bg-blue-50 border-blue-200{% endif %}">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-gray-800">{{ log.action|localize_action }}</span>
                    <span class="text-sm text-gray-600">{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</span>
                </div>
                
                <div class="text-gray-700 mb-3">
                    {% if log.details and log.details.message %}
                        {{ localize_log_message(log.action, log.details.message, log.details) }}
                    {% else %}
                        –ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è
                    {% endif %}
                </div>
                
                {% if log.execution_time_ms %}
                <div class="text-sm text-gray-600 mb-3">
                    ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {{ log.execution_time_ms }}–º—Å
                </div>
                {% endif %}
                
                {% if log.details and log.details|length > 1 %}
                <details class="mt-3">
                    <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">
                        üìã –ü–æ–¥—Ä–æ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </summary>
                    <div class="mt-3 bg-gray-50 border rounded-lg p-4 max-h-96 overflow-y-auto">
                        {{ format_log_details(log.details) | safe }}
                    </div>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üìù</div>
            <div class="text-lg">–õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    const operationStatus = '{{ operation.status }}';
    if (operationStatus === 'pending' || operationStatus === 'processing') {
        setInterval(() => {
            location.reload();
        }, 60000);
    }

    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(() => {
                fallbackCopy(text);
            });
        } else {
            // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopySuccess();
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
        
        document.body.removeChild(textArea);
    }

    function showCopySuccess() {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
        const notification = document.createElement('div');
        notification.textContent = 'SKU —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 2000);
    }

    // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.bg-white');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
{% endblock %}