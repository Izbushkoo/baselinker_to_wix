<script>
    // Получаем данные операции из data-атрибутов
    const operationData = document.getElementById('operation-data');
    const operationOrderId = operationData.dataset.orderId;
    const operationTokenId = operationData.dataset.tokenId;
    const operationAccountName = operationData.dataset.accountName;
    const operationWarehouse = operationData.dataset.warehouse;
    const operationStatus = operationData.dataset.status;
    const operationHasOrderData = operationData.dataset.hasOrderData === 'true';
    const fullOrderElem = document.getElementById("full-order-data");
    let fullOrder = null;
    if (fullOrderElem) {
        try {
            fullOrder = JSON.parse(fullOrderElem.textContent);
        } catch (error) {
            console.error("Ошибка парсинга full-order-data:", error);
        }
    }
    // Автоматическое обновление каждые 60 секунд для активных операций
    if (operationStatus === 'pending' || operationStatus === 'processing') {
        setInterval(async () => {
            console.log('Автоматическое обновление данных операции...');
            await refreshAllData();
        }, 60000);
    }

    // Проверяем и инициализируем функции для избежания ошибок ReferenceError
    function ensureFunctionsExist() {
        const requiredFunctions = ['editPrice', 'closePriceEditModal', 'openTransferModal', 'closeTransferModal', 'addToStock', 'removeFromStock'];
        const missingFunctions = requiredFunctions.filter(func => typeof window[func] !== 'function');
        
        if (missingFunctions.length > 0) {
            console.warn('Следующие функции не определены:', missingFunctions);
            // Создаем заглушки для отсутствующих функций
            missingFunctions.forEach(funcName => {
                window[funcName] = function(...args) {
                    console.warn(`Функция ${funcName} еще не загружена, попробуйте позже`);
                };
            });
        }
    }

    // Вызываем проверку при загрузке
    ensureFunctionsExist();

    /**
     * Форматирует ID заказа для отображения (первые 4 + ... + последние 4)
     */
    function formatOrderId(orderId) {
        if (!orderId || orderId.length <= 12) {
            return orderId;
        }
        return orderId.substring(0, 4) + '...' + orderId.substring(orderId.length - 4);
    }

    /**
     * Определяет статус заказа согласно жизненному циклу и приоритетам
     * Приоритеты: отмена продавцом > основные статусы > отмена покупателем
     * Жизненный цикл: BOUGHT → FILLED_IN → READY_FOR_PROCESSING → SENT
     * 
     * @param {Object} order - Объект заказа с полями status и fulfillment
     * @returns {string} - HTML с цветным тегом статуса заказа
     */
    function getOrderStatus(order) {
        console.log(order)
        if (!order) {
            return '<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">Неизвестно</span>';
        }

        // Приоритет 1: Отмена продавцом (fulfillment.status === 'CANCELLED')
        if (order.fulfillment && order.fulfillment.status === 'CANCELLED') {
            return '<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800">Отменен продавцом</span>';
        }

        // Приоритет 2: Основные статусы жизненного цикла
        // Если заказ отправлен, показываем статус fulfillment
        if (order.fulfillment && order.fulfillment.status === 'SENT') {
            return '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">Отправлен</span>';
        }

        // Основные статусы заказа
        const statusMap = {
            'BOUGHT': '<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">Куплен</span>',
            'FILLED_IN': '<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">Заполнен</span>',
            'READY_FOR_PROCESSING': '<span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">Готов к отправке</span>'
        };

        if (order.status && statusMap[order.status]) {
            return statusMap[order.status];
        }

        // Приоритет 3: Отмена покупателем (основной статус === 'CANCELLED')
        if (order.status === 'CANCELLED') {
            return '<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800">Отменен покупателем</span>';
        }

        // Если статус не распознан, возвращаем как есть
        return `<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">${order.status || 'Неизвестно'}</span>`;
    }

    /**
     * Переключает отображение деталей операции
     */
    function toggleOperationDetails() {
            console.log('toggleOperationDetails вызвана');
            const details = document.getElementById('operationDetails');
            const icon = document.getElementById('toggleIcon');

        if (!details) {
            console.error('Element operationDetails not found');
            return;
        }

        // Используем простой подход с display
        const isHidden = details.style.display === 'none' || window.getComputedStyle(details).display === 'none';
        
        if (isHidden) {
            // Показываем
            details.style.display = 'grid';
            details.classList.remove('collapsed');
            details.classList.add('expanded');
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
            }
        } else {
            // Скрываем
            details.style.display = 'none';
            details.classList.remove('expanded');
            details.classList.add('collapsed');
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }

    /**
     * Переключает отображение товаров заказа
     */
    function toggleOrderItems() {
        console.log('toggleOrderItems вызвана');
        const content = document.getElementById('orderItemsContent');
        const icon = document.getElementById('orderItemsIcon');

        if (!content) {
            console.error('Element orderItemsContent not found');
            return;
        }

        
        // Используем простой подход с display
        const isHidden = content.style.display === 'none' || window.getComputedStyle(content).display === 'none';
        
        if (isHidden) {
            // Показываем
            content.style.display = 'block';
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
            }
        } else {
            // Скрываем
            content.style.display = 'none';
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }

    // Делаем функции доступными глобально
    window.toggleOperationDetails = toggleOperationDetails;
    window.toggleOrderItems = toggleOrderItems;
    window.performStockDeduction = performStockDeduction;
    window.cancelOperation = cancelOperation;
    window.toggleProductsPanel = toggleProductsPanel;
    window.saleFromOrder = saleFromOrder;
    window.openQuickEdit = openQuickEdit;
    window.closeQuickEdit = closeQuickEdit;

    /**
     * Переключает весь блок логов
     */
    function toggleLogsSection() {
        console.log('toggleLogsSection вызвана');
        const content = document.getElementById('logsContent');
        const icon = document.getElementById('logsIcon');

        if (!content) {
            console.error('Element logsContent not found');
            return;
        }

        
        const isHidden = content.style.display === 'none' || window.getComputedStyle(content).display === 'none';
        
        if (isHidden) {
            content.style.display = 'block';
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
            }
        } else {
            content.style.display = 'none';
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }

    /**
     * Переключает детали конкретного лога
     */
    function toggleLogDetails(element) {
        console.log('toggleLogDetails вызвана');
        const details = element.querySelector('.log-details');
        
        if (!details) {
            console.error('Log details not found');
            return;
        }

        console.log('Текущий display деталей лога:', window.getComputedStyle(details).display);
        
        const isHidden = details.style.display === 'none' || window.getComputedStyle(details).display === 'none';
        console.log('isHidden:', isHidden);
        
        if (isHidden) {
            details.style.display = 'block';
            console.log('Детали лога показаны');
        } else {
            details.style.display = 'none';
            console.log('Детали лога скрыты');
        }
    }

    // Делаем функцию доступной глобально
    window.toggleLogDetails = toggleLogDetails;

    /**
     * Выполняет операцию списания
     */
    function performStockDeduction() {
        if (operationOrderId && operationTokenId) {
            saleFromOrder(operationOrderId, operationTokenId);
        } else {
            alert('Недостаточно данных для выполнения операции списания');
        }
    }

    /**
     * Отменяет операцию (заглушка)
     */
    function cancelOperation() {
        alert('Функционал отмены операции будет реализован позже');
    }

    /**
     * Переключает панель товаров (открывает/закрывает)
     */
    function toggleProductsPanel() {
        const panel = document.getElementById('quickEditOverlay');
        const icon = document.getElementById('productsToggleIcon');
        
        if (!panel || !icon) {
            console.error('Элементы панели товаров не найдены');
            return;
        }
        
        // Проверяем, открыта ли панель
        const isOpen = !panel.classList.contains('hidden') && !panel.classList.contains('translate-x-full');
        
        if (isOpen) {
            // Закрываем панель
            closeQuickEdit();
            // Поворачиваем стрелку влево (закрыто)
            icon.style.transform = 'rotate(180deg)';
        } else {
            // Открываем панель
            if (operationData.dataset.skus) {
                openQuickEdit(operationData.dataset.skus);
                // Поворачиваем стрелку вправо (открыто)
                icon.style.transform = 'rotate(0deg)';
            } else {
                alert('Товары не найдены');
            }
        }
    }

    /**
     * Обновляет отображение статуса заказа на странице
     * Использует данные заказа, переданные из бэкенда
     */
    function updateOrderStatusDisplay() {
        const orderStatusElement = document.getElementById('orderStatus');
        if (!orderStatusElement) {
            console.warn('Элемент orderStatus не найден');
            return;
        }

        try {
            // Используем данные fullOrder, если они есть, иначе fallback на window.orderData
            let order = null;
            if (fullOrder) {
                order = fullOrder;
            } else if (typeof window.orderData !== 'undefined' && window.orderData) {
                order = window.orderData;
            }
            if (order) {
                const orderStatus = getOrderStatus(order);
                orderStatusElement.innerHTML = orderStatus;
            } else {
                console.warn('Данные заказа не найдены');
            }
        } catch (error) {
            console.error('Ошибка при обновлении статуса заказа:', error);
        }
    }

    /**
     * Загружает статус списания асинхронно
     */
    async function loadStockStatus() {
        if (!operationOrderId || !operationTokenId) {
            return;
        }

        try {
            const response = await fetch(`/api/stock-status/${operationOrderId}/${operationTokenId}`);
            const data = await response.json();
            updateStockStatus(data.is_stock_updated);
        } catch (error) {
            console.error('Ошибка при загрузке статуса списания:', error);
            updateStockStatus(null);
        }
    }

    /**
     * Обновляет отображение статуса списания
     */
    function updateStockStatus(isStockUpdated) {
        const statusElement = document.getElementById('stockStatus');
        if (!statusElement) return;

        if (isStockUpdated === null) {
            statusElement.textContent = 'Ошибка загрузки';
            statusElement.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-200 text-red-700';
        } else if (isStockUpdated) {
            statusElement.textContent = 'Списано';
            statusElement.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-200 text-green-700';
        } else {
            statusElement.textContent = 'Не списано';
            statusElement.className = 'px-3 py-1 rounded-full text-sm font-medium bg-yellow-200 text-yellow-700';
        }
    }

    /**
     * Обновляет данные операции с сервера
     */
    async function refreshOperationData() {
        try {
            console.log('Обновление данных операции...');
            
            // Получаем ID операции из data-атрибута
            const operationId = operationData?.dataset?.operationId;
            if (!operationId) {
                console.error('Не удалось получить ID операции из data-атрибута');
                return;
            }

            const response = await fetch(`/api/stock-sync/operations/${operationId}/details`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.status === 'success') {
                // Обновляем глобальные переменные
                if (data.operation) {
                    window.operationData = data.operation;
                    // Обновляем статус операции
                    updateOperationStatus(data.operation.status);
                }
                
                // Обновляем отображение
                updateOperationDisplay(data);
                
                console.log('Данные операции обновлены');
            } else {
                console.error('Ошибка при обновлении данных операции:', data.message);
            }
        } catch (error) {
            console.error('Ошибка при обновлении данных операции:', error);
            showNotification('Ошибка при обновлении данных операции', 'error');
        }
    }

    /**
     * Обновляет все данные операции и заказа
     */
    async function refreshAllData() {
        try {
            console.log('Обновление всех данных...');
            await refreshOperationData();
            await refreshOrderData();
            console.log('Все данные обновлены');
        } catch (error) {
            console.error('Ошибка при обновлении всех данных:', error);
        }
    }

    /**
     * Обновляет данные заказа Allegro с сервера
     */
    async function refreshOrderData() {
        try {
            console.log('Обновление данных заказа...');
            
            if (!operationOrderId || !operationTokenId) {
                console.error('Отсутствуют данные заказа для обновления');
                return;
            }

            // Получаем актуальные данные заказа через API
            const response = await fetch(`/api/allegro_sync/orders/${operationTokenId}/${operationOrderId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const orderData = await response.json();
            if (orderData.status === 'success' && orderData.order) {
                // Обновляем глобальную переменную заказа
                window.fullOrder = orderData.order;
                
                // Обновляем отображение заказа
                updateOrderDisplay(orderData.order);
                
                console.log('Данные заказа обновлены');
            } else {
                console.error('Ошибка при обновлении данных заказа:', orderData.message);
            }
        } catch (error) {
            console.error('Ошибка при обновлении данных заказа:', error);
            showNotification('Ошибка при обновлении данных заказа', 'error');
        }
    }

    /**
     * Обновляет отображение операции с новыми данными
     */
    function updateOperationDisplay(operationData) {
        try {
            // Обновляем статус операции
            if (operationData.operation) {
                updateOperationStatus(operationData.operation.status);
            }

            // Обновляем логи операции если есть
            if (operationData.logs && operationData.logs.length > 0) {
                updateOperationLogs(operationData.logs);
            }

            // Обновляем детали валидации если есть
            if (operationData.validation_details) {
                updateValidationDetails(operationData.validation_details);
            }

            console.log('Отображение операции обновлено');
        } catch (error) {
            console.error('Ошибка при обновлении отображения операции:', error);
        }
    }

    /**
     * Обновляет отображение заказа с новыми данными
     */
    function updateOrderDisplay(orderData) {
        try {
            // Обновляем статус заказа
            const orderStatusElement = document.getElementById('orderStatus');
            if (orderStatusElement) {
                orderStatusElement.innerHTML = getOrderStatus(orderData);
            }

            // Обновляем информацию о товарах заказа
            if (orderData.lineItems && orderData.lineItems.length > 0) {
                updateOrderLineItems(orderData.lineItems);
                updateOrderItemsTable(orderData.lineItems); // Обновляем таблицу
            }

            // Обновляем информацию о доставке
            if (orderData.delivery) {
                updateDeliveryInfo(orderData.delivery);
            }

            // Обновляем итоги заказа
            updateOrderSummary(orderData);

            console.log('Отображение заказа обновлено');
        } catch (error) {
            console.error('Ошибка при обновлении отображения заказа:', error);
        }
    }

    /**
     * Обновляет статус операции на странице
     */
    function updateOperationStatus(status) {
        const statusElement = document.getElementById('operationStatus');
        if (!statusElement) return;

        const statusMap = {
            'pending': '<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">Ожидает</span>',
            'processing': '<span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">Обрабатывается</span>',
            'completed': '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">Завершена</span>',
            'failed': '<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800">Ошибка</span>',
            'cancelled': '<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">Отменена</span>'
        };

        statusElement.innerHTML = statusMap[status] || `<span class="px-3 py-1 rounded text-xs bg-gray-100 text-gray-800">${status}</span>`;
    }

    /**
     * Обновляет логи операции
     */
    function updateOperationLogs(logs) {
        const logsContainer = document.getElementById('operationLogs');
        if (!logsContainer) return;

        // Очищаем текущие логи
        logsContainer.innerHTML = '';

        // Добавляем новые логи
        logs.forEach(log => {
            const logElement = document.createElement('div');
            logElement.className = 'log-entry p-3 border-b border-gray-200';
            logElement.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-medium">${log.action}</div>
                    <div class="text-sm text-gray-500">${new Date(log.timestamp).toLocaleString('ru-RU')}</div>
                </div>
                <div class="text-sm text-gray-600 mt-1">${log.details || 'Нет деталей'}</div>
                <div class="text-xs text-gray-400 mt-1">Статус: ${log.status}</div>
            `;
            logsContainer.appendChild(logElement);
        });
    }

    /**
     * Обновляет детали валидации
     */
    function updateValidationDetails(validationDetails) {
        const validationContainer = document.getElementById('validationDetails');
        if (!validationContainer) return;

        // Обновляем статистику валидации
        const totalItems = validationContainer.querySelector('.total-items');
        const validItems = validationContainer.querySelector('.valid-items');
        const invalidItems = validationContainer.querySelector('.invalid-items');

        if (totalItems) totalItems.textContent = validationDetails.total_items;
        if (validItems) validItems.textContent = validationDetails.valid_items;
        if (invalidItems) invalidItems.textContent = validationDetails.invalid_items;

        // Обновляем список ошибок валидации
        const errorsList = validationContainer.querySelector('.validation-errors');
        if (errorsList && validationDetails.validation_errors) {
            errorsList.innerHTML = '';
            validationDetails.validation_errors.forEach(error => {
                const errorElement = document.createElement('li');
                errorElement.className = 'text-red-600 text-sm';
                errorElement.textContent = error;
                errorsList.appendChild(errorElement);
            });
        }
    }

    /**
     * Обновляет товары заказа
     */
    function updateOrderLineItems(lineItems) {
        const lineItemsContainer = document.getElementById('orderLineItems');
        if (!lineItemsContainer) return;

        // Очищаем текущие товары
        lineItemsContainer.innerHTML = '';

        // Добавляем новые товары
        lineItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'line-item p-3 border-b border-gray-200';
            itemElement.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-medium">${item.offer.title || 'Товар'}</div>
                    <div class="text-sm text-gray-500">Количество: ${item.quantity}</div>
                </div>
                <div class="text-sm text-gray-600 mt-1">Цена: ${item.price.amount} ${item.price.currency}</div>
            `;
            lineItemsContainer.appendChild(itemElement);
        });
    }

    /**
     * Обновляет информацию о доставке
     */
    function updateDeliveryInfo(delivery) {
        const deliveryContainer = document.getElementById('deliveryInfo');
        if (!deliveryContainer) return;
        
        // Обновляем информацию о доставке
        const addressElement = deliveryContainer.querySelector('.delivery-address');
        const methodElement = deliveryContainer.querySelector('.delivery-method');
        const costElement = deliveryContainer.querySelector('.delivery-cost');

        if (addressElement && delivery.address) {
            addressElement.textContent = `${delivery.address.street} ${delivery.address.city} ${delivery.address.zipCode}`;
        }
        if (methodElement && delivery.method) {
            methodElement.textContent = delivery.method;
        }
        if (costElement && delivery.cost) {
            costElement.textContent = `${delivery.cost.amount} ${delivery.cost.currency}`;
        }
    }

    /**
     * Принудительно восстанавливает все заблокированные кнопки на странице
     * Используется как дополнительная защита
     */
    function forceRestoreAllButtons() {
        const buttons = document.querySelectorAll('button:disabled');
        let restoredCount = 0;
        
        buttons.forEach(button => {
            button.disabled = false;
            restoredCount++;
        });
        
        if (restoredCount > 0) {
            console.log(`Принудительно восстановлено ${restoredCount} кнопок`);
        }
        
        return restoredCount;
    }

    /**
     * Глобальный обработчик ошибок для восстановления кнопок
     */
    window.addEventListener('error', function(event) {
        console.error('Глобальная ошибка JavaScript:', event.error);
        // Пытаемся восстановить кнопки при критических ошибках
        setTimeout(() => {
            forceRestoreAllButtons();
        }, 1000);
    });

    /**
     * Обработчик необработанных отклонений промисов
     */
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Необработанное отклонение промиса:', event.reason);
        // Пытаемся восстановить кнопки при ошибках промисов
        setTimeout(() => {
            forceRestoreAllButtons();
        }, 1000);
    });


    /**
     * Копирует текст в буфер обмена
     */
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Скопировано в буфер обмена', 'success');
            }).catch(() => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            showNotification('Скопировано в буфер обмена', 'success');
        } catch (err) {
            console.error('Failed to copy text: ', err);
            showNotification('Ошибка копирования', 'error');
        }

        document.body.removeChild(textArea);
    }

    /**
     * Выполняет списание товаров из заказа
     * Адаптированная версия функции из allegro_orders.html
     */
    async function saleFromOrder(orderId, tokenId, buttonElement = null) {
        // Показываем индикатор загрузки
        let button = buttonElement;
        
        // Если кнопка не передана как параметр, пытаемся получить из event
        if (!button && typeof event !== 'undefined' && event.target) {
            button = event.target;
        }
        
        if (button) {
            button.disabled = true;
            console.log('Кнопка заблокирована');
        }

        try {
            console.log('Выполнение списания для заказа:', orderId, 'токен:', tokenId);

            // Получаем данные операции для списания
            const lineItems = [];
            if (fullOrder && fullOrder.lineItems && fullOrder.lineItems.length > 0) {
                lineItems.push(...fullOrder.lineItems);
            } else if (typeof window.operationLineItems !== 'undefined' && window.operationLineItems) {
                lineItems.push(...window.operationLineItems);
            }

            // Отправляем запрос на списание
            const response = await fetch('/api/warehouse/sale-from-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    token_id: tokenId,
                    line_items: lineItems,
                    warehouse: operationWarehouse || 'Ирина'
                })
            });

            const data = await response.json();

            if (response.ok) {
                showNotification(data.message || 'Операция списания выполнена успешно', 'success');
                // Обновляем статус списания на странице
                updateStockStatus(true);
                // Обновляем данные операции и заказа без перезагрузки страницы
                try {
                    await refreshAllData();
                } catch (refreshError) {
                    console.error('Ошибка при обновлении данных:', refreshError);
                    // Даже если обновление не удалось, показываем успех операции
                }
            } else {
                showNotification(data.message || 'Ошибка при выполнении операции списания', 'error');
            }
        } catch (error) {
            console.error('Ошибка при списании товаров:', error);
            showNotification('Ошибка при выполнении операции списания: ' + error.message, 'error');
        } finally {
            // Восстанавливаем кнопку
            if (button) {
                button.disabled = false;
                console.log('Кнопка восстановлена');
            } else {
                console.warn('Кнопка для восстановления не найдена');
            }
        }

        // Дополнительная защита: принудительно восстанавливаем кнопки через 10 секунд
        // на случай, если что-то пошло не так
        setTimeout(() => {
            if (button && button.disabled) {
                button.disabled = false;
                console.log('Кнопка восстановлена по таймауту');
            }
        }, 10000);
    }

    /**
     * Помечает заказ как списанный (сохраняем для совместимости)
     */
    async function markOrderStockUpdated(orderId, tokenId, buttonElement = null) {
        // Показываем индикатор загрузки
        let button = buttonElement;
        
        // Если кнопка не передана как параметр, пытаемся получить из event
        if (!button && typeof event !== 'undefined' && event.target) {
            button = event.target;
        }
        
        if (button) {
            button.disabled = true;
            console.log('Кнопка заблокирована');
        }

        try {

            const response = await fetch(`/api/allegro_sync/orders/${tokenId}/${orderId}/mark_stock_updated`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
            });

            if (response.ok) {
                showNotification('Заказ помечен как списанный', 'success');
                updateStockStatus(true);
                // Обновляем данные заказа без перезагрузки страницы
                await refreshOrderData();
            } else {
                const data = await response.json();
                showNotification(data.message || 'Ошибка при пометке заказа', 'error');
            }
        } catch (error) {
            console.error('Ошибка при пометке заказа:', error);
            showNotification('Ошибка при пометке заказа: ' + error.message, 'error');
        } finally {
            // Восстанавливаем кнопку
            if (button) {
                button.disabled = false;
                console.log('Кнопка markOrderStockUpdated восстановлена');
            } else {
                console.warn('Кнопка markOrderStockUpdated для восстановления не найдена');
            }
        }

        // Дополнительная защита: принудительно восстанавливаем кнопки через 10 секунд
        // на случай, если что-то пошло не так
        setTimeout(() => {
            if (button && button.disabled) {
                button.disabled = false;
                console.log('Кнопка markOrderStockUpdated восстановлена по таймауту');
            }
        }, 10000);
    }

    /**
     * Открывает панель Quick Edit для товаров операции
     * Адаптированная версия функции из inventory.js
     */
    function openQuickEdit(operationSkus) {
        console.log('Открытие Quick Edit для SKU:', operationSkus);

        const panel = document.getElementById('quickEditOverlay');
        const mainContainer = document.getElementById('mainContainer');
        const icon = document.getElementById('productsToggleIcon');

        if (!panel) {
            console.error('Панель Quick Edit не найдена');
            return;
        }

        // Показываем панель
        panel.classList.remove('hidden');
        panel.classList.remove('translate-x-full');
        panel.classList.add('translate-x-0');

        // Устанавливаем направление стрелки вправо (открыто)
        if (icon) {
            icon.style.transform = 'rotate(0deg)';
        }

        // Сдвигаем основной контент влево - учитываем панель (50%)
        if (mainContainer) {
            mainContainer.style.marginRight = '50%';
            mainContainer.style.transition = 'margin-right 0.3s ease-in-out';
        }

        // Загружаем содержимое панели - используем тот же подход что и в старом коде
        fetch(`/products/quick_edit?operation_skus=${encodeURIComponent(operationSkus)}`, {
            headers: { 'Accept': 'application/json' }
        })
            .then(r => r.json())
            .then(data => {
                // Используем готовый HTML от сервера
                if (data.products_html && data.products_html.length > 0) {
                    let html = data.products_html.join('');
                    // Убираем чекбоксы из HTML для операций
                    html = html.replace(/<input[^>]*type="checkbox"[^>]*>/g, '');
                    html = html.replace(/<label[^>]*for="select-[^"]*"[^>]*>.*?<\/label>/g, '');
                    document.getElementById('quickEditContent').innerHTML = '<div class="space-y-4">' + html + '</div>';
                    
                    // Инициализируем количество товаров после загрузки HTML
                    setTimeout(() => {
                        initializeWarehouseQuantities();
                        ensureFunctionsExist(); // Проверяем функции после загрузки контента
                    }, 100);
                } else {
                    document.getElementById('quickEditContent').innerHTML = '<div class="text-center py-12 text-gray-500"><p>Товары не найдены</p></div>';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке Quick Edit:', error);
                showNotification('Ошибка при загрузке панели товаров: ' + error.message, 'error');
                document.getElementById('quickEditContent').innerHTML = '<div class="text-center py-12 text-red-500"><p>Ошибка загрузки товаров</p></div>';
            });
    }

    /**
     * Закрывает панель Quick Edit
     */
    function closeQuickEdit() {
        console.log('Закрытие Quick Edit панели');

        const panel = document.getElementById('quickEditOverlay');
        const mainContainer = document.getElementById('mainContainer');
        const icon = document.getElementById('productsToggleIcon');

        if (panel) {
            panel.classList.remove('translate-x-0');
            panel.classList.add('translate-x-full');

            // Возвращаем основной контент в исходное положение
            if (mainContainer) {
                mainContainer.style.marginRight = '';
            }

            // Сбрасываем направление стрелки влево (закрыто)
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
            }

            // Скрываем панель после завершения анимации
            setTimeout(() => {
                panel.classList.add('hidden');
            }, 300);
        }
    }

    // Делаем функции доступными глобально
    window.copyToClipboard = copyToClipboard;
    window.markOrderStockUpdated = markOrderStockUpdated;
    window.formatOrderId = formatOrderId;
    window.toggleProductsPanel = toggleProductsPanel;

    // Обработчик клавиши Escape для закрытия панели
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            const panel = document.getElementById('quickEditOverlay');
            if (panel && !panel.classList.contains('hidden')) {
                closeQuickEdit();
            }
        }
    });

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {

        updateOrderStatusDisplay();
        
        if (fullOrder && fullOrder.technical_flags && typeof fullOrder.technical_flags.is_stock_updated !== "undefined") {
            updateStockStatus(fullOrder.technical_flags.is_stock_updated);
        }
        
        // Инициализируем данные заказа, если они уже доступны
        if (fullOrder) {
            console.log('Инициализация данных заказа из fullOrder');
            updateOrderDisplay(fullOrder);
        }
        
        // Загружаем статус списания
        loadStockStatus();

        // Инициализируем обработчики кликов
        initializeClickHandlers();

        // Форматируем ID заказов на странице
        formatOrderIdsOnPage();
    });

    /**
     * Инициализирует обработчики кликов для элементов интерфейса
     */
    function initializeClickHandlers() {
        // Обработчик для кнопки сворачивания деталей операции
        const toggleDetailsBtn = document.getElementById('toggleDetails');
        if (toggleDetailsBtn) {
            toggleDetailsBtn.addEventListener('click', toggleOperationDetails);
            console.log('Обработчик для toggleDetails добавлен');
        } else {
            console.warn('Элемент toggleDetails не найден');
        }

        // Обработчик для кнопки сворачивания товаров заказа
        const orderItemsHeader = document.querySelector('[data-toggle="orderItems"]');
        if (orderItemsHeader) {
            orderItemsHeader.addEventListener('click', toggleOrderItems);
            console.log('Обработчик для orderItems добавлен');
        } else {
            console.warn('Элемент с data-toggle="orderItems" не найден');
        }

        // Обработчик для кнопки сворачивания блока логов
        const logsHeader = document.querySelector('[data-toggle="logsSection"]');
        if (logsHeader) {
            logsHeader.addEventListener('click', toggleLogsSection);
            console.log('Обработчик для logsSection добавлен');
        } else {
            console.warn('Элемент с data-toggle="logsSection" не найден');
        }

        // Обработчики для отдельных логов
        const logItems = document.querySelectorAll('[data-toggle="logDetails"]');
        console.log(`Найдено ${logItems.length} элементов логов`);
        logItems.forEach(logItem => {
            logItem.addEventListener('click', function () {
                toggleLogDetails(this);
            });
        });

        // Инициализируем обработчики для модальных окон
        initializeModalHandlers();
    }

    /**
     * Форматирует все ID заказов на странице
     */
    function formatOrderIdsOnPage() {
        const orderIdElements = document.querySelectorAll('[data-order-id]');
        console.log(`Найдено ${orderIdElements.length} элементов с data-order-id`);

        orderIdElements.forEach(element => {
            const orderId = element.dataset.orderId;
            const currentText = element.textContent.trim();

            if (orderId && currentText === orderId) {
                const formattedId = formatOrderId(orderId);
                element.textContent = formattedId;
                element.title = orderId; // Показываем полный ID в tooltip
                console.log(`Форматирован ID: ${orderId} -> ${formattedId}`);
            }
        });
    }

    /**
     * Функция для пополнения товара на складе
     */
    function addToStock(button) {
        const input = button.parentElement.querySelector('input[type="number"]');
        const quantity = parseInt(input.value);
        const warehouse = button.dataset.warehouse;
        const sku = button.dataset.sku;
        const currentQuantity = parseInt(button.dataset.currentQuantity);

        if (isNaN(quantity) || quantity < 1) {
            showNotification('Пожалуйста, введите корректное количество', 'error');
            return;
        }

        // Отключаем кнопку на время запроса
        button.disabled = true;

        fetch('/api/warehouse/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sku: sku,
                warehouse: warehouse,
                quantity: quantity
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при пополнении');
            }
            return response.json();
        })
        .then(data => {
            // Обновляем количество на складе
            const newQuantity = currentQuantity + quantity;
            button.dataset.currentQuantity = newQuantity;
            input.dataset.currentQuantity = newQuantity;
            
            // Обновляем также кнопку "Списать" для этого склада
            const removeButton = button.parentElement.querySelector('[onclick="removeFromStock(this)"]');
            if (removeButton) {
                removeButton.dataset.currentQuantity = newQuantity;
                if (removeButton.disabled) {
                    removeButton.disabled = false;
                }
            }
            
            // Обновляем отображение количества
            const quantityBadge = button.parentElement.parentElement.querySelector('.inline-flex');
            if (quantityBadge) {
                quantityBadge.textContent = `${newQuantity} шт.`;
                quantityBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            }
            
            // Обновляем общее количество
            updateTotalStock();
            
            // Сбрасываем значение input
            input.value = 1;
            
            showNotification('Товар успешно пополнен', 'success');
            // Триггерим событие обновления остатков для автообновления оферт
            document.dispatchEvent(new CustomEvent('stockUpdated'));
            
            // Автоматически перезагружаем блок с товарами через 3 секунды
            setTimeout(async () => {
                try {
                    const operationSkus = operationData?.dataset?.skus;
                    if (operationSkus) {
                        console.log('Автоматическая перезагрузка блока с товарами после пополнения');
                        await reloadQuickEditContent(operationSkus);
                    }
                } catch (error) {
                    console.error('Ошибка при автоматической перезагрузке товаров после пополнения:', error);
                }
            }, 3000);
        })
        .catch(error => {
            showNotification('Ошибка при пополнении товара: ' + error.message, 'error');
        })
        .finally(() => {
            button.disabled = false;
        });
    }

    /**
     * Функция для списания товара со склада
     */
    function removeFromStock(button) {
        const input = button.parentElement.querySelector('input[type="number"]');
        const quantity = parseInt(input.value);
        const warehouse = button.dataset.warehouse;
        const sku = button.dataset.sku;
        const currentQuantity = parseInt(button.dataset.currentQuantity);

        if (isNaN(quantity) || quantity < 1) {
            showNotification('Пожалуйста, введите корректное количество', 'error');
            return;
        }

        if (quantity > currentQuantity) {
            showNotification('Недостаточно товара на складе', 'error');
            return;
        }

        // Отключаем кнопку на время запроса
        button.disabled = true;

        fetch('/api/warehouse/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sku: sku,
                warehouse: warehouse,
                quantity: quantity
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при списании');
            }
            return response.json();
        })
        .then(data => {
            // Обновляем количество на складе
            const newQuantity = currentQuantity - quantity;
            button.dataset.currentQuantity = newQuantity;
            input.dataset.currentQuantity = newQuantity;
            
            // Обновляем также кнопку "Пополнить" для этого склада
            const addButton = button.parentElement.querySelector('[onclick="addToStock(this)"]');
            if (addButton) {
                addButton.dataset.currentQuantity = newQuantity;
            }
            
            // Обновляем отображение количества
            const quantityBadge = button.parentElement.parentElement.querySelector('.inline-flex');
            if (quantityBadge) {
                quantityBadge.textContent = `${newQuantity} шт.`;
                if (newQuantity === 0) {
                    quantityBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                } else {
                    quantityBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                }
            }
            
            // Обновляем общее количество
            updateTotalStock();
            
            // Сбрасываем значение input
            input.value = 1;
            
            showNotification('Товар успешно списан', 'success');
            // Триггерим событие обновления остатков для автообновления оферт
            document.dispatchEvent(new CustomEvent('stockUpdated'));
            
            // Автоматически перезагружаем блок с товарами через 3 секунды
            setTimeout(async () => {
                try {
                    const operationSkus = operationData?.dataset?.skus;
                    if (operationSkus) {
                        console.log('Автоматическая перезагрузка блока с товарами после списания');
                        await reloadQuickEditContent(operationSkus);
                    }
                } catch (error) {
                    console.error('Ошибка при автоматической перезагрузке товаров после списания:', error);
                }
            }, 3000);
        })
        .catch(error => {
            showNotification('Ошибка при списании товара: ' + error.message, 'error');
        })
        .finally(() => {
            if (parseInt(button.dataset.currentQuantity) > 0) {
                button.disabled = false;
            }
        });
    }

    /**
     * Функция для обновления общего количества товара
     */
    function updateTotalStock() {
        // Обновляем общее количество, если элемент существует
        const totalStockElement = document.getElementById('total-stock');
        if (totalStockElement) {
            // Используем только кнопки "Списать" чтобы избежать дублирования
            const removeButtons = document.querySelectorAll('button[onclick="removeFromStock(this)"]');
            
            let totalStock = 0;
            removeButtons.forEach(button => {
                const quantity = parseInt(button.dataset.currentQuantity || 0);
                if (!isNaN(quantity)) {
                    totalStock += quantity;
                }
            });
            
            totalStockElement.textContent = `${totalStock} шт.`;
            
            // Обновляем цвет в зависимости от количества
            if (totalStock === 0) {
                totalStockElement.className = 'text-lg text-red-600';
            } else {
                totalStockElement.className = 'text-lg text-green-600';
            }
        }

        // Обновляем количество для каждого склада отдельно
        const warehouseQuantityElements = document.querySelectorAll('.inline-flex');
        warehouseQuantityElements.forEach(element => {
            // Ищем ближайшую кнопку "Списать" для получения количества
            const removeButton = element.closest('div').querySelector('button[onclick="removeFromStock(this)"]');
            if (removeButton) {
                const quantity = parseInt(removeButton.dataset.currentQuantity || 0);
                if (!isNaN(quantity)) {
                    element.textContent = `${quantity} шт.`;
                    // Обновляем цвет в зависимости от количества
                    if (quantity === 0) {
                        element.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    } else {
                        element.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    }
                }
            }
        });
    }

    /**
     * Показывает уведомление пользователю
     */
    function showNotification(message, type = 'info') {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
        
        // Настраиваем стили в зависимости от типа
        switch (type) {
            case 'success':
                notification.className += ' bg-green-500 text-white';
                break;
            case 'error':
                notification.className += ' bg-red-500 text-white';
                break;
            case 'warning':
                notification.className += ' bg-yellow-500 text-white';
                break;
            default:
                notification.className += ' bg-blue-500 text-white';
        }
        
        notification.textContent = message;
        
        // Добавляем кнопку закрытия
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '&times;';
        closeBtn.className = 'ml-4 text-white hover:text-gray-200 text-xl font-bold';
        closeBtn.onclick = () => {
            notification.remove();
        };
        notification.appendChild(closeBtn);
        
        // Добавляем на страницу
        document.body.appendChild(notification);
        
        // Показываем с анимацией
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Автоматически скрываем через 5 секунд
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 5000);
    }

    /**
     * Инициализирует количество товаров на складах после загрузки HTML
     */
    function initializeWarehouseQuantities() {
        console.log('Инициализация количества товаров на складах...');
        
        // Находим все элементы с количеством товара
        const quantityElements = document.querySelectorAll('.inline-flex');
        
        quantityElements.forEach(element => {
            // Ищем ближайшую кнопку "Списать" для получения количества
            const removeButton = element.closest('div').querySelector('button[onclick="removeFromStock(this)"]');
            if (removeButton) {
                // Пытаемся получить количество из текста элемента
                const quantityText = element.textContent.trim();
                const quantityMatch = quantityText.match(/(\d+)\s*шт\.?/);
                
                if (quantityMatch) {
                    const quantity = parseInt(quantityMatch[1]);
                    if (!isNaN(quantity)) {
                        // Устанавливаем data-атрибут на кнопке
                        removeButton.dataset.currentQuantity = quantity;
                        
                        // Также устанавливаем на кнопке "Пополнить"
                        const addButton = removeButton.parentElement.querySelector('button[onclick="addToStock(this)"]');
                        if (addButton) {
                            addButton.dataset.currentQuantity = quantity;
                        }
                        
                        // Устанавливаем на input поле
                        const input = removeButton.parentElement.querySelector('input[type="number"]');
                        if (input) {
                            input.dataset.currentQuantity = quantity;
                        }
                        
                        console.log(`Инициализировано количество для склада: ${quantity} шт.`);
                    }
                }
            }
        });
        
        // Обновляем отображение общего количества
        updateTotalStock();
    }

    // Делаем функции доступными глобально
    window.addToStock = addToStock;
    window.removeFromStock = removeFromStock;
    window.updateTotalStock = updateTotalStock;
    window.showNotification = showNotification;
    window.initializeWarehouseQuantities = initializeWarehouseQuantities;
    window.openTransferModal = openTransferModal;
    window.closeTransferModal = closeTransferModal;
    window.editPrice = editPrice;
    window.closePriceEditModal = closePriceEditModal;
    window.deleteProduct = deleteProduct;
    window.editProduct = editProduct;
    window.updateProductCard = updateProductCard;
    window.reloadQuickEditContent = reloadQuickEditContent;

    /**
     * Открывает модальное окно для перемещения товара между складами
     */
    function openTransferModal(button) {
        const sku = button.dataset.productSku;
        const name = button.dataset.productName;
        
        console.log('Открываем модалку трансфера для товара:', sku, name);
        
        const modal = document.getElementById('transferModal');
        const skuInput = document.getElementById('transferSku');
        const quantityInput = document.getElementById('transferQuantity');
        const fromSelect = document.getElementById('transferFrom');
        const toSelect = document.getElementById('transferTo');
        
        if (modal && skuInput && quantityInput && fromSelect && toSelect) {
            // Заполняем форму
            skuInput.value = sku;
            quantityInput.value = 1;
            fromSelect.value = '';
            toSelect.value = '';
            
            modal.classList.remove('hidden');
        } else {
            showNotification('Модальное окно перемещения не найдено', 'error');
        }
    }

    /**
     * Закрывает модальное окно перемещения
     */
    function closeTransferModal() {
        const modal = document.getElementById('transferModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    /**
     * Открывает модальное окно для редактирования цены товара
     */
    function editPrice(sku, currentMinPrice) {
        console.log('[LOG] Открытие модального окна редактирования цены для SKU:', sku, 'min_price:', currentMinPrice);
        const modal = document.getElementById('priceEditModal');
        const skuInput = document.getElementById('priceEditSku');
        const priceInput = document.getElementById('priceEditPrice');
        
        if (modal && skuInput && priceInput) {
            skuInput.value = sku;
            priceInput.value = currentMinPrice || '';
            
            modal.classList.remove('hidden');
        } else {
            showNotification('Модальное окно редактирования цены не найдено', 'error');
        }
    }

    /**
     * Закрывает модальное окно редактирования цены
     */
    function closePriceEditModal() {
        const modal = document.getElementById('priceEditModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    /**
     * Удаляет товар после подтверждения
     */
    function deleteProduct(button) {
        const sku = button.dataset.productSku;
        const name = button.dataset.productName;
        
        if (!confirm(`Вы уверены, что хотите удалить товар "${name}" (SKU: ${sku})?`)) {
            return;
        }
        
        // Отключаем кнопку на время запроса
        button.disabled = true;
        
        fetch(`/api/products/${sku}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при удалении товара');
            }
            return response.json();
        })
        .then(data => {
            // Удаляем карточку товара со страницы
            const productCard = button.closest('.flex.items-start.gap-6');
            if (productCard) {
                productCard.remove();
            }
            
            // Показываем сообщение об успехе
            showNotification('Товар успешно удален', 'success');
        })
        .catch(error => {
            showNotification('Ошибка при удалении товара: ' + error.message, 'error');
        })
        .finally(() => {
            button.disabled = false;
        });
    }

    /**
     * Перенаправляет на страницу редактирования товара
     */
    function editProduct(button) {
        const sku = button.dataset.productSku;
        const name = button.dataset.productName;
        
        // Перенаправляем на страницу редактирования
        window.location.href = `/products/${sku}/edit`;
    }

    /**
     * Обновляет карточку товара после перемещения
     */
    async function updateProductCard(sku) {
        try {
            console.log('Обновление карточки товара:', sku);
            
            // Получаем SKU товаров операции для перезагрузки панели
            const operationSkus = operationData?.dataset?.skus;
            if (!operationSkus) {
                console.warn('SKU товаров операции не найдены, перезагружаем страницу');
                location.reload();
                return;
            }
            
            // Перезагружаем содержимое панели быстрого редактирования
            await reloadQuickEditContent(operationSkus);
            
            console.log('Карточка товара успешно обновлена');
        } catch (error) {
            console.error('Ошибка при обновлении карточки товара:', error);
            showNotification('Ошибка при обновлении данных товара', 'error');
            // В случае ошибки делаем полную перезагрузку
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }

    /**
     * Перезагружает содержимое панели быстрого редактирования
     */
    async function reloadQuickEditContent(operationSkus) {
        try {
            console.log('Перезагрузка содержимого панели быстрого редактирования для SKU:', operationSkus);
            
            // Проверяем, что панель быстрого редактирования открыта
            const quickEditContent = document.getElementById('quickEditContent');
            if (!quickEditContent) {
                console.warn('Панель быстрого редактирования не найдена, возможно она не открыта');
                return;
            }
            
            const response = await fetch(`/products/quick_edit?operation_skus=${encodeURIComponent(operationSkus)}`, {
                headers: { 'Accept': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error('Ошибка при получении обновленных данных товаров');
            }
            
            const data = await response.json();
            
            // Обновляем содержимое панели
            if (data.products_html && data.products_html.length > 0) {
                let html = data.products_html.join('');
                // Убираем чекбоксы из HTML для операций
                html = html.replace(/<input[^>]*type="checkbox"[^>]*>/g, '');
                html = html.replace(/<label[^>]*for="select-[^"]*"[^>]*>.*?<\/label>/g, '');
                
                // Добавляем проверки существования функций для избежания ошибок ReferenceError
                html = html.replace(
                    /onclick="([^"]*?)"/g, 
                    'onclick="try { $1 } catch(e) { console.warn(\'Ошибка при вызове функции: $1\', e); }"'
                );
                
                quickEditContent.innerHTML = '<div class="space-y-4">' + html + '</div>';
                
                // Инициализируем количество товаров после загрузки HTML
                setTimeout(() => {
                    initializeWarehouseQuantities();
                    ensureFunctionsExist(); // Проверяем функции после загрузки контента
                }, 100);
            } else {
                quickEditContent.innerHTML = '<div class="text-center py-12 text-gray-500"><p>Товары не найдены</p></div>';
            }
            
            console.log('Содержимое панели быстрого редактирования успешно обновлено');
        } catch (error) {
            console.error('Ошибка при перезагрузке содержимого панели:', error);
            throw error;
        }
    }

    /**
     * Обновляет итоги заказа (стоимость доставки и общую сумму)
     */
    function updateOrderSummary(orderData) {
        try {
            const orderSummaryElement = document.getElementById('orderSummary');
            if (!orderSummaryElement) {
                console.warn('Элемент orderSummary не найден');
                return;
            }

            if (orderData && orderData.summary && orderData.summary.totalToPay) {
                // Обновляем стоимость доставки
                const deliveryCostElement = orderSummaryElement.querySelector('#deliveryCost');
                if (deliveryCostElement && orderData.delivery && orderData.delivery.cost) {
                    const deliveryAmount = parseFloat(orderData.delivery.cost.amount);
                    const deliveryCurrency = orderData.delivery.cost.currency || 'PLN';
                    deliveryCostElement.textContent = `${deliveryAmount.toFixed(2)} ${deliveryCurrency}`;
                } else if (deliveryCostElement) {
                    deliveryCostElement.textContent = '0.00 PLN';
                }

                // Обновляем общую сумму
                const totalAmountElement = orderSummaryElement.querySelector('#totalAmount');
                if (totalAmountElement) {
                    const totalAmount = parseFloat(orderData.summary.totalToPay.amount);
                    const totalCurrency = orderData.summary.totalToPay.currency || 'PLN';
                    totalAmountElement.textContent = `${totalAmount.toFixed(2)} ${totalCurrency}`;
                }

                console.log('Итоги заказа обновлены');
            } else {
                console.warn('Данные итогов заказа недоступны');
            }
        } catch (error) {
            console.error('Ошибка при обновлении итогов заказа:', error);
        }
    }

    /**
     * Обновляет таблицу товаров заказа
     */
    function updateOrderItemsTable(lineItems) {
        try {
            const orderItemsTable = document.getElementById('orderItemsTable');
            if (!orderItemsTable) {
                console.warn('Таблица товаров заказа не найдена');
                return;
            }

            // Очищаем текущие товары
            orderItemsTable.innerHTML = '';

            if (lineItems && lineItems.length > 0) {
                // Добавляем новые товары
                lineItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    
                    // SKU
                    const skuCell = document.createElement('td');
                    skuCell.className = 'px-3 py-2';
                    skuCell.innerHTML = `
                        <button onclick="copyToClipboard('${item.offer.external.id}')"
                            class="font-mono text-gray-800 hover:text-blue-600 cursor-pointer transition-colors">
                            ${item.offer.external.id}
                        </button>
                    `;
                    
                    // Название
                    const nameCell = document.createElement('td');
                    nameCell.className = 'px-3 py-2 text-gray-700';
                    nameCell.textContent = item.offer.name || 'Не указано';
                    
                    // Цена за ед.
                    const priceCell = document.createElement('td');
                    priceCell.className = 'px-3 py-2 text-right text-gray-700';
                    if (item.price && item.price.amount) {
                        const price = parseFloat(item.price.amount);
                        const currency = item.price.currency || 'PLN';
                        priceCell.textContent = `${price.toFixed(2)} ${currency}`;
                    } else {
                        priceCell.textContent = '-';
                    }
                    
                    // Количество
                    const quantityCell = document.createElement('td');
                    quantityCell.className = 'px-3 py-2 text-right text-gray-700';
                    quantityCell.textContent = item.quantity;
                    
                    // Общая цена
                    const totalPriceCell = document.createElement('td');
                    totalPriceCell.className = 'px-3 py-2 text-right text-gray-700';
                    if (item.price && item.price.amount) {
                        const price = parseFloat(item.price.amount);
                        const quantity = parseInt(item.quantity);
                        const totalPrice = price * quantity;
                        const currency = item.price.currency || 'PLN';
                        totalPriceCell.textContent = `${totalPrice.toFixed(2)} ${currency}`;
                    } else {
                        totalPriceCell.textContent = '-';
                    }
                    
                    // Добавляем ячейки в строку
                    row.appendChild(skuCell);
                    row.appendChild(nameCell);
                    row.appendChild(priceCell);
                    row.appendChild(quantityCell);
                    row.appendChild(totalPriceCell);
                    
                    // Добавляем строку в таблицу
                    orderItemsTable.appendChild(row);
                });
                
                console.log(`Обновлено ${lineItems.length} товаров в таблице`);
            } else {
                // Если товаров нет, показываем сообщение
                const noItemsRow = document.createElement('tr');
                noItemsRow.innerHTML = `
                    <td colspan="5" class="px-3 py-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">📦</div>
                        <div>Товары не найдены</div>
                    </td>
                `;
                orderItemsTable.appendChild(noItemsRow);
            }
        } catch (error) {
            console.error('Ошибка при обновлении таблицы товаров:', error);
        }
    }

    /**
     * Инициализирует обработчики для модальных окон
     */
    function initializeModalHandlers() {
        // Обработчик для формы редактирования цены
        const priceEditForm = document.getElementById('priceEditForm');
        if (priceEditForm) {
            priceEditForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const sku = document.getElementById('priceEditSku').value;
                const price = document.getElementById('priceEditPrice').value;
                console.log('[LOG] Отправка запроса на обновление цены:', {sku, min_price: price});
                
                if (!price || parseFloat(price) < 0) {
                    showNotification('Пожалуйста, введите корректную цену', 'error');
                    return;
                }
                
                // Отправляем запрос на обновление цены
                fetch(`/api/prices/${sku}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        min_price: parseFloat(price)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('[LOG] Ошибка при обновлении цены:', response.status, response.statusText);
                        throw new Error('Ошибка при обновлении цены');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[LOG] Цена успешно обновлена:', data);
                    closePriceEditModal();
                    showNotification('Цена успешно обновлена', 'success');
                    
                    // Обновляем карточку товара вместо перезагрузки страницы
                    updateProductCard(sku);
                })
                .catch(error => {
                    console.error('[LOG] Ошибка при обновлении цены:', error);
                    showNotification('Ошибка при обновлении цены: ' + error.message, 'error');
                });
            });
        }

        // Обработчик для формы перемещения товара
        const transferForm = document.getElementById('transferForm');
        if (transferForm) {
            transferForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const sku = document.getElementById('transferSku').value;
                const fromWarehouse = document.getElementById('transferFrom').value;
                const toWarehouse = document.getElementById('transferTo').value;
                const quantity = parseInt(document.getElementById('transferQuantity').value);
                
                if (fromWarehouse === toWarehouse) {
                    showNotification('Склад отправления и назначения не могут быть одинаковыми', 'error');
                    return;
                }
                
                if (isNaN(quantity) || quantity < 1) {
                    showNotification('Пожалуйста, введите корректное количество', 'error');
                    return;
                }
                
                fetch('/api/warehouse/transfer-item/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sku: sku,
                        from_warehouse: fromWarehouse,
                        to_warehouse: toWarehouse,
                        quantity: quantity
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка при перемещении');
                    }
                    return response.json();
                })
                .then(data => {
                    closeTransferModal();
                    showNotification('Товар успешно перемещен', 'success');
                    
                    // Обновляем карточку товара вместо перезагрузки страницы
                    updateProductCard(sku);
                })
                .catch(error => {
                    showNotification('Ошибка при перемещении товара: ' + error.message, 'error');
                });
            });
        }

        // Закрытие модальных окон по клику на фон
        const priceEditModal = document.getElementById('priceEditModal');
        if (priceEditModal) {
            priceEditModal.addEventListener('click', function(e) {
                if (e.target === priceEditModal) {
                    closePriceEditModal();
                }
            });
        }

        const transferModal = document.getElementById('transferModal');
        if (transferModal) {
            transferModal.addEventListener('click', function(e) {
                if (e.target === transferModal) {
                    closeTransferModal();
                }
            });
        }

        // Закрытие модальных окон по нажатию Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePriceEditModal();
                closeTransferModal();
            }
        });
    }
</script>