# План реализации

- [x] 1. Обновить модель данных с новым статусом и полями
  - Добавить статус STOCK_DEDUCTED в enum OperationStatus
  - Добавить новые поля для отслеживания этапов обработки в PendingStockOperation
  - Добавить поля для отмены операций (cancelled_by, cancellation_reason, rollback_operations)
  - Создать enum LogAction со стандартизированными действиями логирования
  - _Требования: 2.3, 3.3, 4.4_

- [x] 2. Создать стандартизированную систему логирования
  - Создать класс StandardizedLogger с методами для разных типов логирования
  - Реализовать метод log_status_transition для логирования переходов статусов
  - Реализовать метод log_action_with_timing для действий с измерением времени
  - Реализовать метод log_validation_failure для стандартизированного логирования валидации
  - Реализовать метод log_error_with_context для ошибок с контекстом
  - _Требования: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3. Интегрировать стандартизированное логирование в сервис
  - Добавить StandardizedLogger как зависимость в StockSynchronizationService
  - Заменить все вызовы self._log_operation на методы StandardizedLogger
  - Обновить все места логирования для использования стандартизированных действий LogAction
  - Добавить логирование переходов статусов во всех местах изменения статуса
  - Добавить измерение времени выполнения для критических операций (загрузка line_items, валидация, списание, синхронизация)
  - _Требования: 1.1, 1.2, 4.4_

- [x] 4. Обновить логику переходов статусов в process_pending_operations
  - Изменить логику обработки PENDING операций для перехода в PROCESSING после загрузки line_items
  - Добавить переход в STOCK_DEDUCTED после успешного списания остатков
  - Обновить логику обработки STOCK_DEDUCTED операций для синхронизации с микросервисом
  - Обновить условия выборки операций для включения STOCK_DEDUCTED статуса
  - Добавить установку временных меток для этапов обработки (line_items_loaded_at, stock_deducted_at, microservice_synced_at)
  - Добавить логирование всех переходов статусов с причинами
  - _Требования: 2.1, 2.2, 2.3, 2.7, 4.1, 4.2, 4.3, 4.4_

- [x] 5. Создать сервис отмены операций
  - Создать файл app/services/operation_cancellation_service.py
  - Создать класс OperationCancellationService с основным методом cancel_operation
  - Реализовать логику отмены для операций в статусе PENDING (только изменение статуса)
  - Реализовать логику отмены для операций в статусе PROCESSING (только изменение статуса)
  - Реализовать логику отмены для операций в статусе STOCK_DEDUCTED (восстановление остатков)
  - Реализовать логику отмены для операций в статусе COMPLETED (полный откат)
  - Интегрировать StandardizedLogger для логирования всех действий отмены
  - _Требования: 3.1, 3.2, 3.3, 3.4_

- [x] 6. Реализовать методы отката изменений в сервисе отмены
  - Создать метод _rollback_stock_changes для восстановления остатков на складе
  - Создать метод _rollback_microservice_status для отката статуса в микросервисе
  - Создать метод _create_adjustment_operation для создания операций корректировки
  - Добавить обработку ошибок отката с детальным логированием
  - _Требования: 3.5, 3.6, 3.8_

- [ ] 7. Интегрировать сервис отмены в основной сервис синхронизации
  - Добавить OperationCancellationService как зависимость в StockSynchronizationService
  - Обновить существующий метод rollback_operation для использования нового сервиса отмены
  - Добавить обработку ошибок отмены с детальным логированием через StandardizedLogger
  - Обновить поля cancelled_by и cancellation_reason при отмене операций
  - _Требования: 3.7, 3.8_

- [ ] 8. Обновить обработку уже обработанных заказов
  - Улучшить логику проверки статуса заказа в микросервисе
  - Добавить корректные переходы в COMPLETED для уже обработанных заказов
  - Добавить обработку отмененных заказов с переходом в COMPLETED
  - Добавить логирование причин завершения операций
  - _Требования: 4.5, 4.6, 4.7_

- [x] 9. Создать миграцию базы данных
  - Создать миграцию для добавления новых полей в PendingStockOperation (line_items_loaded_at, stock_deducted_at, microservice_synced_at, cancelled_by, cancellation_reason, rollback_operations)
  - Добавить индексы для новых полей если необходимо
  - Обновить существующие операции для установки значений по умолчанию
  - _Требования: 2.1, 2.2, 2.3_

- [ ] 10. Создать структуру тестов и написать unit тесты
  - Создать папку tests/ и структуру для тестов
  - Создать тесты для StandardizedLogger (tests/test_standardized_logger.py)
  - Создать тесты для OperationCancellationService (tests/test_operation_cancellation_service.py)
  - Создать тесты для всех переходов статусов в StockSynchronizationService
  - Создать тесты для методов отката изменений
  - Создать тесты для установки временных меток этапов обработки
  - _Требования: 1.1, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4_

- [ ] 11. Написать integration тесты
  - Создать тесты полного жизненного цикла операций с новыми статусами (tests/integration/test_stock_sync_lifecycle.py)
  - Создать тесты отмены операций на разных этапах (tests/integration/test_operation_cancellation.py)
  - Создать тесты обработки ошибок и retry логики
  - Создать тесты интеграции StandardizedLogger с основным сервисом
  - _Требования: 2.7, 3.1, 3.2, 3.3, 3.4, 4.8_

- [ ] 12. Обновить документацию и мониторинг
  - Обновить документацию API с новыми статусами операций
  - Добавить метрики для мониторинга новых статусов
  - Обновить алерты для учета нового жизненного цикла операций
  - _Требования: 2.1, 2.2, 2.3, 4.4_