# План реализации редизайна страницы деталей операции

- [x] 1. Создать новую компактную структуру HTML шаблона
  - Полностью переписать существующий шаблон operation_details.html согласно дизайну
  - Реализовать компактную шапку с кнопкой назад, заголовком, иконкой разворачивания и статусом списания
  - Создать разворачивающийся блок деталей операции с сеткой информационных полей
  - Убрать существующие громоздкие блоки и заменить их на компактные компоненты
  - _Требования: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2_

- [x] 2. Реализовать блок кнопок действий
  - Создать компактный блок с кнопками "Провести операцию списания", "Отменить операцию списания", "Товары"
  - Адаптировать существующие JavaScript функции saleFromOrder и openQuickEdit для новых кнопок
  - Добавить заглушку для кнопки отмены операции (отключенная кнопка)
  - _Требования: 3.1, 3.2, 3.3, 3.4_

- [x] 3. Переработать блок ошибок валидации
  - Преобразовать существующий блок валидации в компактные карточки товаров с ошибками
  - Реализовать отображение изображения товара, SKU с копированием, параметров "Доступно/Требуется/Нехватка"
  - Сохранить условную логику показа блока только при наличии ошибок
  - Адаптировать существующие данные validation_details для нового формата
  - _Требования: 4.1, 4.2, 4.3, 4.4_

- [ ] 4. Создать разворачивающийся блок товаров заказа
  - Заменить существующий блок товаров на компактную таблицу с разворачиванием
  - Создать таблицу с фиксированной высотой и скроллингом для товаров из operation.line_items
  - Добавить колонки: SKU, Название, Цена за ед., Кол-во, Цена
  - Реализовать расчет цены за все товары если она не указана в данных
  - _Требования: 5.1, 5.2, 5.3, 5.4, 5.7_

- [ ] 5. Добавить итоги заказа под таблицей товаров
  - Реализовать отображение стоимости доставки и итоговой суммы заказа
  - Разместить итоги справа внизу от таблицы товаров
  - Получить данные заказа через API микросервиса для отображения order.delivery.cost и order.summary.totalToPay
  - _Требования: 5.6_

- [ ] 6. Обеспечить адаптивность таблицы товаров
  - Настроить CSS для корректного отображения таблицы в половину экрана
  - Предотвратить наплывание заголовков и данных друг на друга
  - Добавить sticky заголовки для таблицы при скроллинге
  - _Требования: 5.5_

- [ ] 7. Переработать блок логов операции
  - Заменить существующий блок "История попыток" на компактный блок "Логи"
  - Создать скроллящийся контейнер фиксированной высоты для записей из StockSynchronizationLog
  - Упростить отображение: статус, timestamp, action для каждой записи
  - Адаптировать существующие данные logs для нового формата
  - _Требования: 6.1, 6.2, 6.3_

- [ ] 8. Реализовать разворачивание деталей логов
  - Добавить обработчик клика на строки логов для разворачивания деталей
  - Реализовать отображение полной информации из поля details мелким текстом
  - Добавить анимацию разворачивания/сворачивания деталей логов
  - _Требования: 6.4, 6.5_

- [ ] 9. Реализовать JavaScript функциональность разворачивания блоков
  - Создать функции для разворачивания/сворачивания шапки с деталями операции
  - Реализовать переключение иконок треугольников при разворачивании
  - Добавить анимации для плавного разворачивания блоков товаров и деталей
  - _Требования: 1.3, 5.1, 5.2_

- [ ] 10. Адаптировать асинхронную загрузку статуса списания
  - Адаптировать существующую функцию loadStockStatus для отображения в новой шапке
  - Обновить функцию updateStockStatus для работы с новым элементом статуса в шапке
  - Сохранить логику получения статуса is_stock_updated от микросервиса
  - _Требования: 1.4_

- [ ] 11. Добавить отображение дополнительных полей операции
  - Реализовать отображение поля stock_deducted_at (дата и время списания стока)
  - Добавить отображение информации о том, кем была отменена операция (cancelled_by)
  - Интегрировать новые поля в блок деталей операции
  - _Требования: 2.6, 2.7_

- [ ] 12. Реализовать логику статусов заказа
  - Создать JavaScript функцию getOrderStatus для определения статуса заказа согласно жизненному циклу
  - Реализовать приоритеты статусов (отмена продавцом > основные статусы > отмена покупателем)
  - Добавить обработку статусов BOUGHT → FILLED_IN → READY_FOR_PROCESSING → SENT
  - Интегрировать с получением данных заказа от микросервиса
  - _Требования: 2.3, 2.4, 2.5_

- [ ] 13. Сохранить существующую функциональность
  - Адаптировать все существующие функции копирования в буфер обмена для новой структуры
  - Сохранить логику открытия Quick Edit панели товаров
  - Адаптировать функции списания и пометки товаров для новых кнопок
  - Сохранить автоматическое обновление страницы для активных операций
  - _Требования: 7.1, 7.2, 7.3, 7.4_

- [ ] 14. Оптимизировать производительность и добавить обработку ошибок
  - Добавить обработку ошибок для всех асинхронных операций
  - Реализовать индикаторы загрузки для длительных операций
  - Оптимизировать рендеринг больших списков товаров и логов
  - Добавить валидацию данных перед отображением